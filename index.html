<!DOCTYPE html>
<html lang="fr">
<head>
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Chasse</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Application de suivi de chasse avec GPS, statistiques et cartographie">
    <meta name="theme-color" content="#2c5530">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Suivi Chasse">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
     <meta name="theme-color" content="#2c5530">
     <!-- Leaflet CSS -->
     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
     <!-- Leaflet JavaScript -->
     <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
     <!-- Chart.js -->
     <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Reset et base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
            background: #f8f9fa;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .nav-tab {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            color: #2c5530;
            border-bottom-color: #2c5530;
            background: #f8f9fa;
        }

        .nav-tab:hover {
            background: #f8f9fa;
            color: #2c5530;
        }

        /* Main Content */
        .main-content {
            padding: 1rem;
            min-height: calc(100vh - 140px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Sessions List */
        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .session-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .session-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .session-date {
            font-weight: 600;
            color: #2c5530;
            font-size: 1.1rem;
        }

                 .session-duration {
             background: #e9ecef;
             padding: 0.25rem 0.75rem;
             border-radius: 20px;
             font-size: 0.8rem;
             color: #6c757d;
         }
         
         .session-duration.session-ongoing {
             background: #fff3cd;
             color: #856404;
             border: 1px solid #ffeaa7;
         }

        .session-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .session-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .session-detail i {
            color: #6c757d;
            width: 16px;
        }

        .session-stats {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* Statistics */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            font-size: 2rem;
            font-weight: 700;
            color: #2c5530;
        }

                 .chart-container {
             background: white;
             padding: 1.5rem;
             border-radius: 12px;
             box-shadow: 0 4px 6px rgba(0,0,0,0.05);
             border: 1px solid #e9ecef;
         }
         
         /* Statistiques d√©taill√©es */
         .detailed-stats {
             display: flex;
             flex-direction: column;
             gap: 1.5rem;
             margin-top: 2rem;
         }
         
         .stats-section {
             background: white;
             padding: 1.5rem;
             border-radius: 12px;
             box-shadow: 0 4px 6px rgba(0,0,0,0.05);
             border: 1px solid #e9ecef;
         }
         
         .stats-section h3 {
             color: #2c5530;
             margin-bottom: 1rem;
             font-size: 1.1rem;
             display: flex;
             align-items: center;
             gap: 0.5rem;
         }
         
         .species-stats, .monthly-stats, .weather-stats, .location-stats {
             display: grid;
             gap: 1rem;
         }
         
         .stat-item-detailed {
             background: #f8f9fa;
             padding: 1rem;
             border-radius: 8px;
             border-left: 4px solid #2c5530;
         }
         
         .stat-item-detailed h4 {
             color: #2c5530;
             margin-bottom: 0.5rem;
             font-size: 1rem;
         }
         
         .stat-item-detailed .stat-numbers {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 0.5rem;
         }
         
         .stat-item-detailed .stat-bar {
             background: #e9ecef;
             height: 8px;
             border-radius: 4px;
             overflow: hidden;
             margin-top: 0.5rem;
         }
         
         .stat-item-detailed .stat-bar-fill {
             height: 100%;
             background: linear-gradient(90deg, #2c5530, #4a7c59);
             transition: width 0.3s ease;
         }
         
         .activity-chart {
             height: 300px;
             position: relative;
             background: #f8f9fa;
             border-radius: 8px;
             padding: 1rem;
         }
         
         .chart-canvas {
             width: 100%;
             height: 100%;
         }
         
         .empty-stats {
             text-align: center;
             padding: 2rem;
             color: #6c757d;
             font-style: italic;
         }
         
         /* Styles pour l'onglet carte */
         .map-controls {
             background: white;
             padding: 1.5rem;
             border-radius: 12px;
             box-shadow: 0 4px 6px rgba(0,0,0,0.05);
             border: 1px solid #e9ecef;
             margin-bottom: 1.5rem;
         }
         
         .map-filters h3 {
             color: #2c5530;
             margin-bottom: 1rem;
             font-size: 1.1rem;
         }
         
         .filter-group {
             margin-bottom: 1rem;
         }
         
         .filter-group label {
             display: block;
             margin-bottom: 0.5rem;
             font-weight: 500;
             color: #495057;
         }
         
         .map-filter {
             width: 100%;
             padding: 0.75rem;
             border: 1px solid #ced4da;
             border-radius: 8px;
             font-size: 1rem;
             background: white;
         }
         
         .checkbox-group {
             display: flex;
             gap: 1rem;
             flex-wrap: wrap;
         }
         
         .checkbox-label {
             display: flex;
             align-items: center;
             gap: 0.5rem;
             cursor: pointer;
             padding: 0.5rem;
             border-radius: 6px;
             transition: background-color 0.2s;
         }
         
         .checkbox-label:hover {
             background: #f8f9fa;
         }
         
         .checkbox-label input[type="checkbox"] {
             width: auto;
             margin: 0;
         }
         
         .map-container {
             background: white;
             border-radius: 12px;
             box-shadow: 0 4px 6px rgba(0,0,0,0.05);
             border: 1px solid #e9ecef;
             overflow: hidden;
         }
         
         .map-canvas {
             height: 500px;
             position: relative;
             background: #f8f9fa;
             overflow: hidden;
         }
         
         .map-canvas canvas {
             display: block;
             max-width: 100%;
             max-height: 100%;
         }
         
         /* Styles pour Leaflet */
         .leaflet-container {
             height: 100%;
             width: 100%;
         }
         
         .leaflet-popup-content {
             font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
             font-size: 14px;
             line-height: 1.4;
         }
         
         .leaflet-popup-content h3 {
             margin: 0 0 8px 0;
             color: #2c5530;
             font-size: 16px;
         }
         
         .leaflet-popup-content .popup-detail {
             margin: 4px 0;
             display: flex;
             align-items: center;
             gap: 8px;
         }
         
         .leaflet-popup-content .popup-detail strong {
             color: #495057;
             min-width: 60px;
         }
         
         .map-legend {
             padding: 1rem;
             border-top: 1px solid #e9ecef;
             display: flex;
             gap: 1rem;
             justify-content: center;
         }
         
         .legend-item {
             display: flex;
             align-items: center;
             gap: 0.5rem;
             font-size: 0.9rem;
             color: #495057;
         }
         
         .legend-color {
             width: 16px;
             height: 16px;
             border-radius: 50%;
             border: 2px solid white;
             box-shadow: 0 1px 3px rgba(0,0,0,0.2);
         }
         
         .harvest-color {
             background: #dc3545;
         }
         
         .observation-color {
             background: #ffc107;
         }
         
         .map-point {
             position: absolute;
             width: 12px;
             height: 12px;
             border-radius: 50%;
             border: 2px solid white;
             box-shadow: 0 2px 4px rgba(0,0,0,0.3);
             cursor: pointer;
             transition: transform 0.2s;
         }
         
         .map-point:hover {
             transform: scale(1.2);
         }
         
         .map-point.harvest {
             background: #dc3545;
         }
         
         .map-point.observation {
             background: #ffc107;
         }
         
         .map-tooltip {
             position: absolute;
             background: rgba(0,0,0,0.8);
             color: white;
             padding: 0.5rem;
             border-radius: 4px;
             font-size: 0.8rem;
             pointer-events: none;
             z-index: 1000;
             max-width: 200px;
             display: none;
         }

        /* Settings */
        .settings-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .settings-container h3 {
            margin-bottom: 1.5rem;
            color: #2c5530;
        }

        .setting-item {
            margin-bottom: 1.5rem;
        }

        .setting-item label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .setting-item input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .setting-item input:focus {
            outline: none;
            border-color: #2c5530;
            box-shadow: 0 0 0 3px rgba(44, 85, 48, 0.1);
        }

        /* Buttons */
        .btn-primary, .btn-secondary, .btn-danger {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #2c5530;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3a22;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #2c5530;
            font-size: 1.25rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .close-btn:hover {
            background-color: #e9ecef;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2c5530;
            box-shadow: 0 0 0 3px rgba(44, 85, 48, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid #e9ecef;
        }

        .form-actions button {
            flex: 1;
        }

        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid #e9ecef;
        }

        /* Harvest and Observation Lists */
        .harvest-list, .observation-list {
            margin-top: 1rem;
        }

        .harvest-item, .observation-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 4px solid #2c5530;
        }

        .harvest-item h4, .observation-item h4 {
            color: #2c5530;
            margin-bottom: 0.5rem;
        }

        .harvest-details, .observation-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.25rem;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .session-details {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 0.75rem;
            }
            
            .session-card {
                padding: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-card p {
                font-size: 1.5rem;
            }
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: #6c757d;
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #e9ecef;
            border-top: 2px solid #2c5530;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #495057;
        }

        .empty-state p {
            margin-bottom: 2rem;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-up {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Styles pour les images */
        .image-preview {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e9ecef;
            background: #f8f9fa;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview .remove-image {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-preview .remove-image:hover {
            background: rgba(220, 53, 69, 1);
        }

        .harvest-images, .observation-images {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .harvest-image, .observation-image {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e9ecef;
            background: #f8f9fa;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .harvest-image:hover, .observation-image:hover {
            transform: scale(1.05);
        }

        .harvest-image img, .observation-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Modal pour afficher les images en grand */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
        }

        .image-modal-content {
            position: relative;
            margin: 2% auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .image-modal img {
            width: 100%;
            height: auto;
            max-height: 90vh;
            object-fit: contain;
        }

        .image-modal .close-image {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
        }

        .image-modal .close-image:hover {
            color: #bbb;
        }

        .image-counter {
            position: absolute;
            bottom: 15px;
            left: 15px;
            color: #f1f1f1;
            font-size: 16px;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 20px;
        }

        /* Notification animations */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Styles pour les trajets GPS et points d'int√©r√™t */
        .gps-tracking {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
            margin-bottom: 1.5rem;
        }

        .tracking-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tracking-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tracking-btn.recording {
            background: #dc3545;
            color: white;
            animation: pulse 2s infinite;
        }

        .tracking-btn.recording:hover {
            background: #c82333;
        }

        .tracking-btn.paused {
            background: #ffc107;
            color: #212529;
        }

        .tracking-btn.paused:hover {
            background: #e0a800;
        }

        .tracking-btn.stopped {
            background: #28a745;
            color: white;
        }

        .tracking-btn.stopped:hover {
            background: #218838;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .tracking-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .tracking-stat {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .tracking-stat h4 {
            color: #2c5530;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .tracking-stat p {
            font-size: 1.5rem;
            font-weight: 700;
            color: #495057;
            margin: 0;
        }

        .poi-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
            margin-bottom: 1.5rem;
        }

        .poi-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: end;
        }

        .poi-form .form-group {
            margin-bottom: 0;
        }

        .poi-list {
            display: grid;
            gap: 0.75rem;
        }

        .poi-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #2c5530;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .poi-info h4 {
            color: #2c5530;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .poi-info p {
            color: #6c757d;
            font-size: 0.9rem;
            margin: 0;
        }

        .poi-actions {
            display: flex;
            gap: 0.5rem;
        }

        .poi-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }

        .poi-btn.view {
            background: #007bff;
            color: white;
        }

        .poi-btn.view:hover {
            background: #0056b3;
        }

        .poi-btn.delete {
            background: #dc3545;
            color: white;
        }

        .poi-btn.delete:hover {
            background: #c82333;
        }

        .track-path {
            stroke: #2c5530;
            stroke-width: 3;
            fill: none;
            opacity: 0.8;
        }

        .track-point {
            fill: #2c5530;
            stroke: white;
            stroke-width: 2;
        }

        .poi-marker {
            fill: #ffc107;
            stroke: #212529;
            stroke-width: 2;
        }

        .poi-marker:hover {
            fill: #e0a800;
        }

                 /* Responsive pour les contr√¥les GPS */
         @media (max-width: 768px) {
             .tracking-controls {
                 flex-direction: column;
             }
             
             .tracking-info {
                 grid-template-columns: 1fr;
             }
             
             .poi-form {
                 grid-template-columns: 1fr;
             }
         }

         /* Styles pour les graphiques avanc√©s */
         .advanced-stats {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
             gap: 1.5rem;
             margin-top: 2rem;
         }

         .chart-container {
             background: white;
             padding: 1.5rem;
             border-radius: 12px;
             box-shadow: 0 4px 6px rgba(0,0,0,0.05);
             border: 1px solid #e9ecef;
         }

         .chart-container h3 {
             color: #2c5530;
             margin-bottom: 1rem;
             font-size: 1.1rem;
             display: flex;
             align-items: center;
             gap: 0.5rem;
         }

         .chart-filters {
             display: flex;
             gap: 1rem;
             margin-bottom: 1rem;
             flex-wrap: wrap;
         }

         .chart-filter {
             padding: 0.5rem 1rem;
             border: 1px solid #ced4da;
             border-radius: 6px;
             background: white;
             font-size: 0.9rem;
             cursor: pointer;
             transition: all 0.2s;
         }

         .chart-filter.active {
             background: #2c5530;
             color: white;
             border-color: #2c5530;
         }

         .chart-filter:hover {
             background: #f8f9fa;
         }

         .chart-filter.active:hover {
             background: #1e3a22;
         }

         .chart-canvas-container {
             position: relative;
             height: 300px;
             margin-top: 1rem;
         }
         
         /* Animation pour le bouton d'installation PWA */
         @keyframes slideIn {
             from {
                 transform: translateX(100%);
                 opacity: 0;
             }
             to {
                 transform: translateX(0);
                 opacity: 1;
             }
         }


    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>üèπ Suivi Chasse</h1>
            <button id="newSessionBtn" class="btn-primary">Nouvelle Session</button>
        </header>

                 <!-- Navigation -->
         <nav class="nav-tabs">
             <button class="nav-tab active" data-tab="sessions">Sessions</button>
             <button class="nav-tab" data-tab="stats">Statistiques</button>
             <button class="nav-tab" data-tab="map">Carte</button>
             <button class="nav-tab" data-tab="settings">Param√®tres</button>
         </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sessions Tab -->
            <div id="sessions" class="tab-content active">
                <div class="sessions-list" id="sessionsList">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>

                         <!-- Stats Tab -->
             <div id="stats" class="tab-content">
                 <div class="stats-container">
                     <div class="stat-card">
                         <h3>Total Sessions</h3>
                         <p id="totalSessions">0</p>
                     </div>
                     <div class="stat-card">
                         <h3>Heures Totales</h3>
                         <p id="totalHours">0h</p>
                     </div>
                     <div class="stat-card">
                         <h3>Pr√©l√®vements</h3>
                         <p id="totalHarvests">0</p>
                     </div>
                     <div class="stat-card">
                         <h3>Observations</h3>
                         <p id="totalObservations">0</p>
                     </div>
                     <div class="stat-card">
                         <h3>Dur√©e Moyenne</h3>
                         <p id="avgDuration">0h</p>
                     </div>
                     <div class="stat-card">
                         <h3>Efficacit√©</h3>
                         <p id="efficiency">0%</p>
                     </div>
                 </div>
                 
                 <!-- Statistiques avanc√©es avec graphiques -->
                 <div class="advanced-stats">
                     <!-- Graphique des pr√©l√®vements par esp√®ce -->
                     <div class="chart-container">
                         <h3>üèπ Pr√©l√®vements par Esp√®ce</h3>
                         <div class="chart-filters">
                             <button class="chart-filter active" data-filter="harvests">Pr√©l√®vements</button>
                             <button class="chart-filter" data-filter="observations">Observations</button>
                             <button class="chart-filter" data-filter="both">Les deux</button>
                         </div>
                         <div class="chart-canvas-container">
                             <canvas id="speciesChart"></canvas>
                         </div>
                     </div>
                     
                     <!-- Graphique d'√©volution temporelle -->
                     <div class="chart-container">
                         <h3>üìà √âvolution Temporelle</h3>
                         <div class="chart-filters">
                             <button class="chart-filter active" data-period="months">Par mois</button>
                             <button class="chart-filter" data-period="weeks">Par semaine</button>
                             <button class="chart-filter" data-period="days">Par jour</button>
                         </div>
                         <div class="chart-canvas-container">
                             <canvas id="timelineChart"></canvas>
                         </div>
                     </div>
                     
                     <!-- Graphique de performance par m√©t√©o -->
                     <div class="chart-container">
                         <h3>üå§Ô∏è Performance par M√©t√©o</h3>
                         <div class="chart-canvas-container">
                             <canvas id="weatherChart"></canvas>
                         </div>
                     </div>
                     
                     <!-- Graphique de r√©partition des activit√©s -->
                     <div class="chart-container">
                         <h3>üìä R√©partition des Activit√©s</h3>
                         <div class="chart-canvas-container">
                             <canvas id="activityChart"></canvas>
                         </div>
                         </div>
                     </div>
                     

             </div>
 
             <!-- Map Tab -->
             <div id="map" class="tab-content">
                 <div class="map-controls">
                     <div class="map-filters">
                         <h3>üó∫Ô∏è Carte des Activit√©s</h3>
                         <div class="filter-group">
                             <label>Filtrer par esp√®ce:</label>
                             <select id="speciesFilter" class="map-filter">
                                 <option value="all">Toutes les esp√®ces</option>
                                 <!-- Les options seront g√©n√©r√©es dynamiquement -->
                             </select>
                         </div>
                         <div class="filter-group">
                             <label>Type d'activit√©:</label>
                             <div class="checkbox-group">
                                 <label class="checkbox-label">
                                     <input type="checkbox" id="showHarvests" checked>
                                     <span>üèπ Pr√©l√®vements</span>
                                 </label>
                                 <label class="checkbox-label">
                                     <input type="checkbox" id="showObservations" checked>
                                     <span>üëÅÔ∏è Observations</span>
                                 </label>
                             </div>
                         </div>
                         <button id="updateMap" class="btn-primary">Actualiser la carte</button>
                     </div>
                 </div>
                 
                 <div class="map-container">
                     <div id="mapCanvas" class="map-canvas" style="min-height:500px;width:100%;position:relative;">
  <div id="mapDebug" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;z-index:1000;display:none;"></div>
                         <!-- La carte OpenStreetMap sera g√©n√©r√©e ici -->
                     </div>
                     <div class="map-legend">
                         <div class="legend-item">
                             <span class="legend-color harvest-color"></span>
                             <span>Pr√©l√®vements</span>
                         </div>
                         <div class="legend-item">
                             <span class="legend-color observation-color"></span>
                             <span>Observations</span>
                         </div>
                         <div class="legend-item">
                             <span class="legend-color" style="background: #2c5530;"></span>
                             <span>Trajets GPS</span>
                         </div>
                         <div class="legend-item">
                             <span class="legend-color" style="background: #ffc107;"></span>
                             <span>Points d'int√©r√™t</span>
                         </div>
                     </div>
                 </div>

                 <!-- Section Trajets GPS -->
                 <div class="gps-tracking">
                     <h3>üó∫Ô∏è Enregistrement GPS par Session</h3>
                     
                     <!-- S√©lecteur de session -->
                     <div class="form-group" style="margin-bottom: 1rem;">
                         <label for="trackingSession">Session de chasse :</label>
                         <select id="trackingSession" class="map-filter">
                             <option value="">S√©lectionner une session</option>
                             <!-- Les sessions seront g√©n√©r√©es dynamiquement -->
                         </select>
                     </div>
                     
                     <div class="tracking-controls">
                         <button id="startTracking" class="tracking-btn stopped" disabled>
                             <span>‚ñ∂Ô∏è</span>
                             <span>D√©marrer l'enregistrement</span>
                         </button>
                         <button id="pauseTracking" class="tracking-btn" style="display: none;">
                             <span>‚è∏Ô∏è</span>
                             <span>Pause</span>
                         </button>
                         <button id="stopTracking" class="tracking-btn" style="display: none;">
                             <span>‚èπÔ∏è</span>
                             <span>Arr√™ter</span>
                         </button>
                         <button id="saveTrack" class="tracking-btn" style="display: none;">
                             <span>üíæ</span>
                             <span>Sauvegarder le trajet</span>
                         </button>
                     </div>
                     
                     <div class="tracking-info" id="trackingInfo" style="display: none;">
                         <div class="tracking-stat">
                             <h4>Dur√©e</h4>
                             <p id="trackingDuration">00:00:00</p>
                         </div>
                         <div class="tracking-stat">
                             <h4>Distance</h4>
                             <p id="trackingDistance">0.0 km</p>
                         </div>
                         <div class="tracking-stat">
                             <h4>Points GPS</h4>
                             <p id="trackingPoints">0</p>
                         </div>
                         <div class="tracking-stat">
                             <h4>Vitesse moy.</h4>
                             <p id="trackingSpeed">0.0 km/h</p>
                         </div>
                     </div>
                     
                     <!-- Informations sur la session s√©lectionn√©e -->
                     <div id="sessionInfo" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                         <h4 style="color: #2c5530; margin-bottom: 0.5rem;">Session s√©lectionn√©e</h4>
                         <div id="sessionDetails"></div>
                     </div>
                 </div>

                 <!-- Section Points d'Int√©r√™t -->
                 <div class="poi-section">
                     <h3>üìç Points d'Int√©r√™t</h3>
                     <form id="poiForm" class="poi-form">
                         <div class="form-group">
                             <label for="poiName">Nom du point:</label>
                             <input type="text" id="poiName" placeholder="Ex: Poste de chasse, Point d'eau" required>
                         </div>
                         <div class="form-group">
                             <label for="poiType">Type:</label>
                             <select id="poiType" required>
                                 <option value="poste">Poste de chasse</option>
                                 <option value="eau">Point d'eau</option>
                                 <option value="passage">Passage de gibier</option>
                                 <option value="nourrissage">Zone de nourrissage</option>
                                 <option value="repos">Zone de repos</option>
                                 <option value="autre">Autre</option>
                             </select>
                         </div>
                         <button type="submit" class="btn-primary">Ajouter</button>
                     </form>
                     
                     <div class="poi-list" id="poiList">
                         <!-- Les points d'int√©r√™t seront affich√©s ici -->
                     </div>
                 </div>

                 <!-- Section Trajets Sauvegard√©s -->
                 <div class="poi-section">
                     <h3>üó∫Ô∏è Trajets Sauvegard√©s</h3>
                     <div class="poi-list" id="savedTracksList">
                         <!-- Les trajets sauvegard√©s seront affich√©s ici -->
                     </div>
                 </div>
             </div>
 
             <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="settings-container">
                    <h3>Param√®tres</h3>
                    <div class="setting-item">
                        <label for="hunterName">Nom du chasseur:</label>
                        <input type="text" id="hunterName" placeholder="Votre nom">
                    </div>
                    <div class="setting-item">
                        <label for="licenseNumber">Num√©ro de licence:</label>
                        <input type="text" id="licenseNumber" placeholder="Num√©ro de licence">
                    </div>
                                         <div class="setting-item">
                         <label for="defaultLocation">Lieu par d√©faut:</label>
                         <input type="text" id="defaultLocation" placeholder="Zone de chasse habituelle">
                     </div>
                     
                     <div class="setting-item">
                         <label>Liste des esp√®ces de gibier:</label>
                         <div id="gameSpeciesList" style="margin-top: 0.5rem;">
                             <!-- La liste sera g√©n√©r√©e dynamiquement -->
                         </div>
                         <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                             <input type="text" id="newSpecies" placeholder="Nouvelle esp√®ce" style="flex: 1;">
                             <button type="button" id="addSpecies" class="btn-secondary" style="white-space: nowrap;">Ajouter</button>
                         </div>
                     </div>
                     
                     <button id="exportData" class="btn-secondary">Exporter les donn√©es</button>
                     <button id="importData" class="btn-secondary">Importer des donn√©es</button>
                     <input type="file" id="fileInput" accept=".json" style="display: none;">
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for new session -->
    <div id="sessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nouvelle Session de Chasse</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <form id="sessionForm">
                <div class="form-group">
                    <label for="sessionDate">Date:</label>
                    <input type="date" id="sessionDate" name="sessionDate" required>
                </div>
                <div class="form-group">
                    <label for="sessionStart">Heure de d√©but:</label>
                    <input type="time" id="sessionStart" name="sessionStart" required>
                </div>
                                 <div class="form-group">
                     <label for="sessionEnd">Heure de fin:</label>
                     <input type="time" id="sessionEnd" name="sessionEnd" disabled style="background-color: #f8f9fa; color: #6c757d;">
                     <small style="color: #6c757d; font-size: 0.8rem;">L'heure de fin sera d√©finie √† la fin de la session</small>
                 </div>
                                 <div class="form-group">
                     <label for="sessionLocationName">Nom du lieu:</label>
                     <input type="text" id="sessionLocationName" name="sessionLocationName" placeholder="Nom de la zone de chasse">
                 </div>
                 <div class="form-group">
                     <label for="sessionLocation">Coordonn√©es GPS:</label>
                     <div style="display: flex; gap: 0.5rem;">
                         <input type="text" id="sessionLocation" name="sessionLocation" placeholder="Coordonn√©es GPS" style="flex: 1;">
                         <button type="button" id="getLocationBtn" class="btn-secondary" style="white-space: nowrap;">üìç GPS</button>
                     </div>
                     <div id="locationStatus" style="font-size: 0.8rem; margin-top: 0.25rem; color: #6c757d;"></div>
                 </div>
                <div class="form-group">
                    <label for="sessionWeather">M√©t√©o:</label>
                    <select id="sessionWeather" name="sessionWeather">
                        <option value="ensoleill√©">Ensoleill√©</option>
                        <option value="nuageux">Nuageux</option>
                        <option value="pluvieux">Pluvieux</option>
                        <option value="neigeux">Neigeux</option>
                        <option value="venteux">Venteux</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sessionNotes">Notes:</label>
                    <textarea id="sessionNotes" name="sessionNotes" placeholder="Observations, conditions, etc."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Enregistrer</button>
                    <button type="button" class="btn-secondary" id="cancelSession">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for session details -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>D√©tails de la Session</h2>
                <button class="close-btn" id="closeDetailsModal">&times;</button>
            </div>
            <div id="sessionDetails">
                <!-- Session details will be loaded here -->
            </div>
                         <div class="modal-actions">
                 <button id="editSession" class="btn-secondary">Modifier Session</button>
                 <button id="addHarvest" class="btn-primary">Ajouter Pr√©l√®vement</button>
                 <button id="addObservation" class="btn-secondary">Ajouter Observation</button>
                 <button id="deleteSession" class="btn-danger">Supprimer Session</button>
             </div>
        </div>
    </div>

    <!-- Modal for harvest/observation -->
    <div id="harvestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="harvestModalTitle">Ajouter Pr√©l√®vement</h2>
                <button class="close-btn" id="closeHarvestModal">&times;</button>
            </div>
            <form id="harvestForm">
                                 <div class="form-group">
                     <label for="harvestType">Type:</label>
                     <select id="harvestType" name="harvestType" required>
                         <!-- Les options seront g√©n√©r√©es dynamiquement -->
                     </select>
                 </div>
                <div class="form-group">
                    <label for="harvestTime">Heure:</label>
                    <input type="time" id="harvestTime" name="harvestTime" required>
                </div>
                <div class="form-group">
                    <label for="harvestWeight">Poids (kg):</label>
                    <input type="number" id="harvestWeight" name="harvestWeight" step="0.1" placeholder="Poids estim√©">
                </div>
                                 <div class="form-group">
                     <label for="harvestLocationName">Nom du lieu:</label>
                     <input type="text" id="harvestLocationName" name="harvestLocationName" placeholder="Nom du lieu">
                 </div>
                 <div class="form-group">
                     <label for="harvestLocation">Coordonn√©es GPS:</label>
                     <div style="display: flex; gap: 0.5rem;">
                         <input type="text" id="harvestLocation" name="harvestLocation" placeholder="Coordonn√©es GPS" readonly style="flex: 1; background-color: #f8f9fa;">
                         <button type="button" id="getHarvestLocationBtn" class="btn-secondary" style="white-space: nowrap;">üìç GPS</button>
                     </div>
                     <div id="harvestLocationStatus" style="font-size: 0.8rem; margin-top: 0.25rem; color: #6c757d;"></div>
                 </div>
                <div class="form-group">
                    <label for="harvestNotes">Notes:</label>
                    <textarea id="harvestNotes" name="harvestNotes" placeholder="D√©tails sur le pr√©l√®vement"></textarea>
                </div>
                <div class="form-group">
                    <label for="harvestImages">Images (optionnel):</label>
                    <input type="file" id="harvestImages" name="harvestImages" accept="image/*" multiple>
                    <small style="color: #6c757d; font-size: 0.8rem;">Vous pouvez s√©lectionner plusieurs images. Format recommand√©: JPG, PNG</small>
                    <div id="imagePreview" style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Enregistrer</button>
                    <button type="button" class="btn-secondary" id="cancelHarvest">Annuler</button>
                </div>
            </form>
        </div>
         </div>
 
     <!-- Modal for editing session -->
     <div id="editSessionModal" class="modal">
         <div class="modal-content">
             <div class="modal-header">
                 <h2>Modifier la Session</h2>
                 <button class="close-btn" id="closeEditModal">&times;</button>
             </div>
             <form id="editSessionForm">
                 <div class="form-group">
                     <label for="editSessionDate">Date:</label>
                     <input type="date" id="editSessionDate" name="editSessionDate" required>
                 </div>
                 <div class="form-group">
                     <label for="editSessionStart">Heure de d√©but:</label>
                     <input type="time" id="editSessionStart" name="editSessionStart" required>
                 </div>
                 <div class="form-group">
                     <label for="editSessionEnd">Heure de fin:</label>
                     <input type="time" id="editSessionEnd" name="editSessionEnd">
                 </div>
                 <div class="form-group">
                     <label for="editSessionLocationName">Nom du lieu:</label>
                     <input type="text" id="editSessionLocationName" name="editSessionLocationName" placeholder="Nom de la zone de chasse">
                 </div>
                 <div class="form-group">
                     <label for="editSessionLocation">Coordonn√©es GPS:</label>
                     <div style="display: flex; gap: 0.5rem;">
                         <input type="text" id="editSessionLocation" name="editSessionLocation" placeholder="Coordonn√©es GPS" style="flex: 1;">
                         <button type="button" id="getEditLocationBtn" class="btn-secondary" style="white-space: nowrap;">üìç GPS</button>
                     </div>
                     <div id="editLocationStatus" style="font-size: 0.8rem; margin-top: 0.25rem; color: #6c757d;"></div>
                 </div>
                 <div class="form-group">
                     <label for="editSessionWeather">M√©t√©o:</label>
                     <select id="editSessionWeather" name="editSessionWeather">
                         <option value="ensoleill√©">Ensoleill√©</option>
                         <option value="nuageux">Nuageux</option>
                         <option value="pluvieux">Pluvieux</option>
                         <option value="neigeux">Neigeux</option>
                         <option value="venteux">Venteux</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label for="editSessionNotes">Notes:</label>
                     <textarea id="editSessionNotes" name="editSessionNotes" placeholder="Observations, conditions, etc."></textarea>
                 </div>
                 <div class="form-actions">
                     <button type="submit" class="btn-primary">Enregistrer les modifications</button>
                     <button type="button" class="btn-secondary" id="cancelEdit">Annuler</button>
                 </div>
             </form>
         </div>
     </div>

     <!-- Modal pour afficher les images en grand -->
     <div id="imageModal" class="image-modal">
         <span class="close-image" id="closeImageModal">&times;</span>
         <div class="image-modal-content">
             <img id="modalImage" src="" alt="Image">
             <div class="image-counter" id="imageCounter"></div>
         </div>
     </div>
 
     <script>
        // Application de Suivi de Chasse
        class HuntingTracker {
            constructor() {
                this.sessions = JSON.parse(localStorage.getItem('huntingSessions')) || [];
                this.settings = JSON.parse(localStorage.getItem('huntingSettings')) || {};
                this.currentSessionId = null;
                this.isHarvestMode = false;
                this.sessionGPS = null;
                this.harvestGPS = null;
                this.selectedImages = []; // Pour stocker les images s√©lectionn√©es
                this.currentImageIndex = 0; // Pour le modal d'images
                
                // Variables pour le tracking GPS
                this.isTracking = false;
                this.isPaused = false;
                this.trackingStartTime = null;
                this.trackingInterval = null;
                this.gpsTrack = []; // Points GPS enregistr√©s
                this.pointsOfInterest = JSON.parse(localStorage.getItem('huntingPOI')) || [];
                this.currentPosition = null;
                this.watchId = null;
                this.selectedSessionId = null; // Session s√©lectionn√©e pour le tracking
                
                // Variables pour les graphiques
                this.charts = {}; // Stockage des instances de graphiques
                this.currentChartFilters = {
                    species: 'harvests',
                    timeline: 'months'
                };
                
                this.init();
            }

                         init() {
                 this.setupEventListeners();
                 this.loadSettings();
                 this.renderSessions();
                 this.updateStats();
                 this.setDefaultDate();
                 this.renderPOIList();
                 this.renderSavedTracksList();
                 this.populateSessionSelector();
                 

             }

            setupEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });

                // Nouvelle session
                document.getElementById('newSessionBtn').addEventListener('click', () => this.openSessionModal());
                document.getElementById('closeModal').addEventListener('click', () => this.closeSessionModal());
                document.getElementById('cancelSession').addEventListener('click', () => this.closeSessionModal());
                document.getElementById('sessionForm').addEventListener('submit', (e) => this.saveSession(e));

                                 // GPS pour session
                 document.getElementById('getLocationBtn').addEventListener('click', () => this.getCurrentLocation('session'));

                                 // D√©tails session
                 document.getElementById('closeDetailsModal').addEventListener('click', () => this.closeDetailsModal());
                 document.getElementById('editSession').addEventListener('click', () => this.openEditSessionModal());
                 document.getElementById('addHarvest').addEventListener('click', () => this.openHarvestModal(true));
                 document.getElementById('addObservation').addEventListener('click', () => this.openHarvestModal(false));
                 document.getElementById('deleteSession').addEventListener('click', () => this.deleteSession());

                // Harvest/Observation modal
                document.getElementById('closeHarvestModal').addEventListener('click', () => this.closeHarvestModal());
                document.getElementById('cancelHarvest').addEventListener('click', () => this.closeHarvestModal());
                document.getElementById('harvestForm').addEventListener('submit', (e) => this.saveHarvest(e));

                                 // GPS pour harvest/observation
                 document.getElementById('getHarvestLocationBtn').addEventListener('click', () => this.getCurrentLocation('harvest'));
                 
                 // Gestion des images
                 document.getElementById('harvestImages').addEventListener('change', (e) => this.handleImageSelection(e));
                 document.getElementById('closeImageModal').addEventListener('click', () => this.closeImageModal());
                 
                 // √âdition de session
                 document.getElementById('closeEditModal').addEventListener('click', () => this.closeEditSessionModal());
                 document.getElementById('cancelEdit').addEventListener('click', () => this.closeEditSessionModal());
                 document.getElementById('editSessionForm').addEventListener('submit', (e) => this.saveEditedSession(e));
                 document.getElementById('getEditLocationBtn').addEventListener('click', () => this.getCurrentLocation('edit'));

                                 // Settings
                 document.getElementById('exportData').addEventListener('click', () => this.exportData());
                 document.getElementById('importData').addEventListener('click', () => document.getElementById('fileInput').click());
                 document.getElementById('fileInput').addEventListener('change', (e) => this.importData(e));
                 
                 // Gestion de la liste des esp√®ces
                 document.getElementById('addSpecies').addEventListener('click', () => this.addGameSpecies());
                 document.getElementById('newSpecies').addEventListener('keypress', (e) => {
                     if (e.key === 'Enter') {
                         e.preventDefault();
                         this.addGameSpecies();
                     }
                 });

                                 // Fermer modals en cliquant √† l'ext√©rieur
                 window.addEventListener('click', (e) => {
                     if (e.target.classList.contains('modal')) {
                         this.closeAllModals();
                     }
                     if (e.target.classList.contains('image-modal')) {
                         this.closeImageModal();
                     }
                 });
                 
                 // Contr√¥les de la carte
                 document.getElementById('updateMap').addEventListener('click', () => this.updateMap());
                 document.getElementById('speciesFilter').addEventListener('change', () => this.updateMap());
                 document.getElementById('showHarvests').addEventListener('change', () => this.updateMap());
                 document.getElementById('showObservations').addEventListener('change', () => this.updateMap());
                 
                 // Fermer le modal d'image avec √âchap
                 document.addEventListener('keydown', (e) => {
                     if (e.key === 'Escape') {
                         this.closeImageModal();
                     }
                 });
                 
                 // Contr√¥les GPS
                 document.getElementById('startTracking').addEventListener('click', () => this.startGPSTracking());
                 document.getElementById('pauseTracking').addEventListener('click', () => this.pauseGPSTracking());
                 document.getElementById('stopTracking').addEventListener('click', () => this.stopGPSTracking());
                 document.getElementById('saveTrack').addEventListener('click', () => this.saveGPSTrack());
                 
                 // Points d'int√©r√™t
                 document.getElementById('poiForm').addEventListener('submit', (e) => this.addPointOfInterest(e));
                 
                 // S√©lecteur de session pour le tracking
                 document.getElementById('trackingSession').addEventListener('change', (e) => this.onSessionSelect(e));
                 
                 // Graphiques avanc√©s
                 document.querySelectorAll('.chart-filter').forEach(filter => {
                     filter.addEventListener('click', (e) => this.onChartFilterClick(e));
                 });
                 

            }

                         switchTab(tabName) {
                 // Mettre √† jour les onglets
                 document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                 document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                 // Mettre √† jour le contenu
                 document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                 document.getElementById(tabName).classList.add('active');

                 // Mettre √† jour les stats si n√©cessaire
                 if (tabName === 'stats') {
                     this.updateStats();
                 }
                 
                 // Mettre √† jour la carte si n√©cessaire
                 if (tabName === 'map') {
                     // Attendre que le DOM soit mis √† jour
                     setTimeout(() => {
                         this.updateMap();
                         this.renderPOIList(); // Recharger la liste des POI
                         this.renderSavedTracksList(); // Recharger la liste des trajets
                         this.populateSessionSelector(); // Mettre √† jour le s√©lecteur de session
                     }, 300);
                 }
             }

                         setDefaultDate() {
                 const today = new Date().toISOString().split('T')[0];
                 document.getElementById('sessionDate').value = today;
             }
             
             setSessionEndTime(sessionId) {
                 const now = new Date();
                 const currentTime = now.toTimeString().slice(0, 5); // Format HH:MM
                 
                 // Mettre √† jour la session
                 const session = this.sessions.find(s => s.id === sessionId);
                 if (session) {
                     session.endTime = currentTime;
                     this.saveToStorage();
                     
                     // Mettre √† jour l'affichage
                     const endTimeDisplay = document.getElementById('endTimeDisplay');
                     if (endTimeDisplay) {
                         endTimeDisplay.textContent = currentTime;
                     }
                     
                     // Mettre √† jour les statistiques
                     this.updateStats();
                     
                     this.showNotification('Heure de fin mise √† jour !');
                 }
             }

                         openSessionModal() {
                 document.getElementById('sessionModal').style.display = 'block';
                 this.setDefaultDate();
                 // Ne pas d√©finir automatiquement l'heure de fin
                 document.getElementById('sessionLocationName').value = this.settings.defaultLocation || '';
             }

            closeSessionModal() {
                document.getElementById('sessionModal').style.display = 'none';
                document.getElementById('sessionForm').reset();
            }

                         saveSession(e) {
                 e.preventDefault();
                 
                 const formData = new FormData(e.target);
                 const session = {
                     id: Date.now().toString(),
                     date: formData.get('sessionDate'),
                     startTime: formData.get('sessionStart'),
                     endTime: null, // L'heure de fin sera d√©finie plus tard
                     locationName: formData.get('sessionLocationName'),
                     locationGPS: formData.get('sessionLocation'),
                     weather: formData.get('sessionWeather'),
                     notes: formData.get('sessionNotes'),
                     harvests: [],
                     observations: [],
                     createdAt: new Date().toISOString()
                 };

                this.sessions.unshift(session);
                this.saveToStorage();
                this.renderSessions();
                this.closeSessionModal();
                
                // Afficher un message de succ√®s
                this.showNotification('Session enregistr√©e avec succ√®s !');
            }

                         getCurrentLocation(type) {
                 let statusElement;
                 if (type === 'session') {
                     statusElement = document.getElementById('locationStatus');
                 } else if (type === 'harvest') {
                     statusElement = document.getElementById('harvestLocationStatus');
                 } else if (type === 'edit') {
                     statusElement = document.getElementById('editLocationStatus');
                 }
                 
                 statusElement.textContent = 'üìç R√©cup√©ration de la position...';
                 
                 if (!navigator.geolocation) {
                     statusElement.textContent = '‚ùå G√©olocalisation non support√©e';
                     return;
                 }
 
                 navigator.geolocation.getCurrentPosition(
                     (position) => {
                         const { latitude, longitude } = position.coords;
                         const locationText = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                         
                         if (type === 'session') {
                             document.getElementById('sessionLocation').value = locationText;
                         } else if (type === 'harvest') {
                             document.getElementById('harvestLocation').value = locationText;
                         } else if (type === 'edit') {
                             document.getElementById('editSessionLocation').value = locationText;
                         }
                         
                         statusElement.textContent = '‚úÖ Position enregistr√©e';
                         
                         // Sauvegarder les coordonn√©es GPS
                         if (type === 'session') {
                             this.sessionGPS = { latitude, longitude };
                         } else if (type === 'harvest') {
                             this.harvestGPS = { latitude, longitude };
                         }
                     },
                    (error) => {
                        let errorMessage = '‚ùå Erreur de g√©olocalisation';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = '‚ùå Permission refus√©e';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = '‚ùå Position indisponible';
                                break;
                            case error.TIMEOUT:
                                errorMessage = '‚ùå D√©lai d√©pass√©';
                                break;
                        }
                        statusElement.textContent = errorMessage;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            }

            renderSessions() {
                const sessionsList = document.getElementById('sessionsList');
                
                if (this.sessions.length === 0) {
                    sessionsList.innerHTML = `
                        <div class="empty-state">
                            <h3>Aucune session enregistr√©e</h3>
                            <p>Commencez par cr√©er votre premi√®re session de chasse</p>
                            <button class="btn-primary" onclick="huntingTracker.openSessionModal()">Cr√©er une session</button>
                        </div>
                    `;
                    return;
                }

                sessionsList.innerHTML = this.sessions.map(session => {
                    const duration = this.calculateDuration(session.startTime, session.endTime);
                    const harvestCount = session.harvests.length;
                    const observationCount = session.observations.length;
                    
                    return `
                        <div class="session-card slide-up" onclick="huntingTracker.openSessionDetails('${session.id}')">
                            <div class="session-header">
                                <div class="session-date">${this.formatDate(session.date)}</div>
                                <div class="session-duration">${duration}</div>
                            </div>
                                                         <div class="session-details">
                                 <div class="session-detail">
                                     <i>üìç</i>
                                     <span>${session.locationName || 'Non sp√©cifi√©'}</span>
                                 </div>
                                 <div class="session-detail">
                                     <i>${this.getWeatherIcon(session.weather)}</i>
                                     <span>${session.weather || 'Non sp√©cifi√©'}</span>
                                 </div>
                             </div>
                            <div class="session-stats">
                                <div class="stat-item">
                                    <span>üèπ</span>
                                    <span>${harvestCount} pr√©l√®vement${harvestCount > 1 ? 's' : ''}</span>
                                </div>
                                <div class="stat-item">
                                    <span>üëÅÔ∏è</span>
                                    <span>${observationCount} observation${observationCount > 1 ? 's' : ''}</span>
                                </div>
                                ${session.gpsTrack ? `
                                    <div class="stat-item">
                                        <span>üó∫Ô∏è</span>
                                        <span>${session.gpsTrack.distance ? session.gpsTrack.distance.toFixed(1) + ' km' : 'Trajet GPS'}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            openSessionDetails(sessionId) {
                this.currentSessionId = sessionId;
                const session = this.sessions.find(s => s.id === sessionId);
                
                if (!session) return;

                const detailsContainer = document.getElementById('sessionDetails');
                detailsContainer.innerHTML = `
                    <div style="padding: 1.5rem;">
                                                 <div class="session-header">
                             <h3>${this.formatDate(session.date)}</h3>
                             <span class="session-duration ${!session.endTime ? 'session-ongoing' : ''}">${this.calculateDuration(session.startTime, session.endTime)}</span>
                         </div>
                        
                                                 <div class="session-details" style="margin: 1rem 0;">
                             <div class="session-detail">
                                 <strong>D√©but:</strong> ${session.startTime}
                             </div>
                             <div class="session-detail">
                                 <strong>Fin:</strong> 
                                 <div style="display: flex; align-items: center; gap: 0.5rem;">
                                     <span id="endTimeDisplay">${session.endTime || 'Non d√©finie'}</span>
                                     <button type="button" onclick="huntingTracker.setSessionEndTime('${session.id}')" class="btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">üïê Maintenant</button>
                                 </div>
                             </div>
                             <div class="session-detail">
                                 <strong>Lieu:</strong> ${session.locationName || 'Non sp√©cifi√©'}
                                 ${session.locationGPS ? `<br><small style="color: #6c757d;">GPS: ${session.locationGPS}</small>` : ''}
                             </div>
                                                           <div class="session-detail">
                                  <strong>M√©t√©o:</strong> ${this.getWeatherIcon(session.weather)} ${session.weather || 'Non sp√©cifi√©'}
                              </div>
                             ${session.gpsTrack ? `
                                 <div class="session-detail">
                                     <strong>Trajet GPS:</strong> 
                                     <span style="color: #28a745;">${session.gpsTrack.distance ? session.gpsTrack.distance.toFixed(1) + ' km' : 'Enregistr√©'}</span>
                                     ${session.gpsTrack.duration ? ` ‚Ä¢ ${this.formatDuration(session.gpsTrack.duration)}` : ''}
                                 </div>
                             ` : ''}
                         </div>
                        
                        ${session.notes ? `<div style="margin: 1rem 0;"><strong>Notes:</strong><br>${session.notes}</div>` : ''}
                        
                        <div class="harvest-list">
                            <h4>Pr√©l√®vements (${session.harvests.length})</h4>
                            ${session.harvests.length > 0 ? 
                                session.harvests.map(harvest => `
                                    <div class="harvest-item">
                                        <h4>${harvest.type}</h4>
                                                                                 <div class="harvest-details">
                                             <div>Heure: ${harvest.time}</div>
                                             ${harvest.weight ? `<div>Poids: ${harvest.weight} kg</div>` : ''}
                                             ${harvest.locationName ? `<div>üìç ${harvest.locationName}</div>` : ''}
                                         </div>
                                        ${harvest.notes ? `<div style="margin-top: 0.5rem; font-size: 0.9rem;">${harvest.notes}</div>` : ''}
                                        ${harvest.gps ? `<div style="margin-top: 0.5rem; font-size: 0.8rem; color: #28a745;">
                                            <a href="https://maps.google.com/?q=${harvest.gps.latitude},${harvest.gps.longitude}" target="_blank" style="color: inherit;">
                                                üó∫Ô∏è Voir sur la carte
                                            </a>
                                        </div>` : ''}
                                        ${harvest.images && harvest.images.length > 0 ? `
                                            <div class="harvest-images">
                                                ${harvest.images.map((image, index) => `
                                                    <div class="harvest-image" onclick="huntingTracker.openImageModal(${JSON.stringify(harvest.images)}, ${index})">
                                                        <img src="${image}" alt="Image ${index + 1}">
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('') : 
                                '<p style="color: #6c757d; font-style: italic;">Aucun pr√©l√®vement enregistr√©</p>'
                            }
                        </div>
                        
                        <div class="observation-list">
                            <h4>Observations (${session.observations.length})</h4>
                            ${session.observations.length > 0 ? 
                                session.observations.map(obs => `
                                    <div class="observation-item">
                                        <h4>${obs.type}</h4>
                                                                                 <div class="observation-details">
                                             <div>Heure: ${obs.time}</div>
                                             ${obs.count ? `<div>Nombre: ${obs.count}</div>` : ''}
                                             ${obs.locationName ? `<div>üìç ${obs.locationName}</div>` : ''}
                                         </div>
                                        ${obs.notes ? `<div style="margin-top: 0.5rem; font-size: 0.9rem;">${obs.notes}</div>` : ''}
                                        ${obs.gps ? `<div style="margin-top: 0.5rem; font-size: 0.8rem; color: #28a745;">
                                            <a href="https://maps.google.com/?q=${obs.gps.latitude},${obs.gps.longitude}" target="_blank" style="color: inherit;">
                                                üó∫Ô∏è Voir sur la carte
                                            </a>
                                        </div>` : ''}
                                        ${obs.images && obs.images.length > 0 ? `
                                            <div class="observation-images">
                                                ${obs.images.map((image, index) => `
                                                    <div class="observation-image" onclick="huntingTracker.openImageModal(${JSON.stringify(obs.images)}, ${index})">
                                                        <img src="${image}" alt="Image ${index + 1}">
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('') : 
                                '<p style="color: #6c757d; font-style: italic;">Aucune observation enregistr√©e</p>'
                            }
                        </div>
                    </div>
                `;
                
                document.getElementById('detailsModal').style.display = 'block';
            }

                         closeDetailsModal() {
                 document.getElementById('detailsModal').style.display = 'none';
                 this.currentSessionId = null;
             }
             
             openEditSessionModal() {
                 if (!this.currentSessionId) return;
                 
                 const session = this.sessions.find(s => s.id === this.currentSessionId);
                 if (!session) return;
                 
                 // Remplir le formulaire avec les donn√©es actuelles
                 document.getElementById('editSessionDate').value = session.date;
                 document.getElementById('editSessionStart').value = session.startTime;
                 document.getElementById('editSessionEnd').value = session.endTime || '';
                 document.getElementById('editSessionLocationName').value = session.locationName || '';
                 document.getElementById('editSessionLocation').value = session.locationGPS || '';
                 document.getElementById('editSessionWeather').value = session.weather || 'ensoleill√©';
                 document.getElementById('editSessionNotes').value = session.notes || '';
                 
                 // Afficher le modal
                 document.getElementById('editSessionModal').style.display = 'block';
             }
             
             closeEditSessionModal() {
                 document.getElementById('editSessionModal').style.display = 'none';
                 document.getElementById('editSessionForm').reset();
             }
             
             saveEditedSession(e) {
                 e.preventDefault();
                 
                 if (!this.currentSessionId) return;
                 
                 const formData = new FormData(e.target);
                 const session = this.sessions.find(s => s.id === this.currentSessionId);
                 
                 if (!session) return;
                 
                 // Mettre √† jour les donn√©es de la session
                 session.date = formData.get('editSessionDate');
                 session.startTime = formData.get('editSessionStart');
                 session.endTime = formData.get('editSessionEnd') || null;
                 session.locationName = formData.get('editSessionLocationName');
                 session.locationGPS = formData.get('editSessionLocation');
                 session.weather = formData.get('editSessionWeather');
                 session.notes = formData.get('editSessionNotes');
                 
                 // Sauvegarder et mettre √† jour l'affichage
                 this.saveToStorage();
                 this.renderSessions();
                 this.closeEditSessionModal();
                 this.openSessionDetails(this.currentSessionId); // Recharger les d√©tails
                 
                 this.showNotification('Session modifi√©e avec succ√®s !');
             }

                         openHarvestModal(isHarvest) {
                 this.isHarvestMode = isHarvest;
                 const modal = document.getElementById('harvestModal');
                 const title = document.getElementById('harvestModalTitle');
                 
                 title.textContent = isHarvest ? 'Ajouter Pr√©l√®vement' : 'Ajouter Observation';
                 
                 // Mettre √† jour les options du select avec la liste pr√©d√©finie
                 this.updateHarvestTypeOptions();
                 
                 // Ajuster les champs selon le type
                 const weightField = document.getElementById('harvestWeight').parentElement;
                 weightField.style.display = isHarvest ? 'block' : 'none';
                 
                 // Ajouter un champ nombre pour les observations
                 let countField = document.getElementById('harvestCount');
                 if (!countField && !isHarvest) {
                     const weightInput = document.getElementById('harvestWeight');
                     countField = document.createElement('div');
                     countField.className = 'form-group';
                     countField.innerHTML = `
                         <label for="harvestCount">Nombre:</label>
                         <input type="number" id="harvestCount" name="harvestCount" min="1" placeholder="Nombre d'animaux observ√©s">
                     `;
                     weightInput.parentElement.parentElement.insertBefore(countField, weightInput.parentElement);
                 } else if (countField && isHarvest) {
                     countField.remove();
                 }
                 
                 // R√©initialiser les champs GPS
                 document.getElementById('harvestLocation').value = '';
                 document.getElementById('harvestLocationName').value = '';
                 document.getElementById('harvestLocationStatus').textContent = '';
                 
                 modal.style.display = 'block';
                 document.getElementById('harvestTime').value = new Date().toTimeString().slice(0, 5);
             }

            closeHarvestModal() {
                document.getElementById('harvestModal').style.display = 'none';
                document.getElementById('harvestForm').reset();
                
                // Supprimer le champ nombre s'il existe
                const countField = document.getElementById('harvestCount');
                if (countField) countField.remove();
                
                // R√©initialiser les variables GPS
                this.harvestGPS = null;
                document.getElementById('harvestLocationStatus').textContent = '';
                
                // R√©initialiser les images
                this.selectedImages = [];
                document.getElementById('imagePreview').innerHTML = '';
            }

            // M√©thodes pour la gestion des images
            handleImageSelection(e) {
                const files = Array.from(e.target.files);
                const previewContainer = document.getElementById('imagePreview');
                
                files.forEach((file, index) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const imageData = event.target.result;
                            this.selectedImages.push(imageData);
                            this.addImagePreview(imageData, this.selectedImages.length - 1);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            addImagePreview(imageData, index) {
                const previewContainer = document.getElementById('imagePreview');
                const previewDiv = document.createElement('div');
                previewDiv.className = 'image-preview';
                previewDiv.innerHTML = `
                    <img src="${imageData}" alt="Aper√ßu">
                    <button type="button" class="remove-image" onclick="huntingTracker.removeImage(${index})">&times;</button>
                `;
                previewContainer.appendChild(previewDiv);
            }

            removeImage(index) {
                this.selectedImages.splice(index, 1);
                this.updateImagePreviews();
            }

            updateImagePreviews() {
                const previewContainer = document.getElementById('imagePreview');
                previewContainer.innerHTML = '';
                this.selectedImages.forEach((imageData, index) => {
                    this.addImagePreview(imageData, index);
                });
            }

            openImageModal(images, startIndex = 0) {
                if (!images || images.length === 0) return;
                
                this.currentImageIndex = startIndex;
                this.updateModalImage(images);
                document.getElementById('imageModal').style.display = 'block';
            }

            updateModalImage(images) {
                const modalImage = document.getElementById('modalImage');
                const imageCounter = document.getElementById('imageCounter');
                
                modalImage.src = images[this.currentImageIndex];
                imageCounter.textContent = `${this.currentImageIndex + 1} / ${images.length}`;
                
                // Ajouter les boutons de navigation si plusieurs images
                if (images.length > 1) {
                    if (!document.getElementById('prevImage')) {
                        const prevBtn = document.createElement('button');
                        prevBtn.id = 'prevImage';
                        prevBtn.innerHTML = '&#10094;';
                        prevBtn.style.cssText = `
                            position: absolute;
                            top: 50%;
                            left: 20px;
                            transform: translateY(-50%);
                            background: rgba(0,0,0,0.7);
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 50px;
                            height: 50px;
                            font-size: 24px;
                            cursor: pointer;
                            z-index: 2001;
                        `;
                        prevBtn.onclick = () => this.navigateImage(images, -1);
                        document.getElementById('imageModal').appendChild(prevBtn);
                    }
                    
                    if (!document.getElementById('nextImage')) {
                        const nextBtn = document.createElement('button');
                        nextBtn.id = 'nextImage';
                        nextBtn.innerHTML = '&#10095;';
                        nextBtn.style.cssText = `
                            position: absolute;
                            top: 50%;
                            right: 20px;
                            transform: translateY(-50%);
                            background: rgba(0,0,0,0.7);
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 50px;
                            height: 50px;
                            font-size: 24px;
                            cursor: pointer;
                            z-index: 2001;
                        `;
                        nextBtn.onclick = () => this.navigateImage(images, 1);
                        document.getElementById('imageModal').appendChild(nextBtn);
                    }
                }
            }

            navigateImage(images, direction) {
                this.currentImageIndex = (this.currentImageIndex + direction + images.length) % images.length;
                this.updateModalImage(images);
            }

            closeImageModal() {
                document.getElementById('imageModal').style.display = 'none';
                
                // Nettoyer les boutons de navigation
                const prevBtn = document.getElementById('prevImage');
                const nextBtn = document.getElementById('nextImage');
                if (prevBtn) prevBtn.remove();
                if (nextBtn) nextBtn.remove();
            }

                         // M√©thodes pour le tracking GPS par session
             onSessionSelect(e) {
                 const sessionId = e.target.value;
                 this.selectedSessionId = sessionId;
                 
                 if (sessionId) {
                     const session = this.sessions.find(s => s.id === sessionId);
                     if (session) {
                         this.displaySessionInfo(session);
                         document.getElementById('startTracking').disabled = false;
                     }
                } else {
                     this.hideSessionInfo();
                     document.getElementById('startTracking').disabled = true;
                 }
             }

             displaySessionInfo(session) {
                 const infoDiv = document.getElementById('sessionInfo');
                 const detailsDiv = document.getElementById('sessionDetails');
                 
                 detailsDiv.innerHTML = `
                     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
                         <div>
                             <strong>Date:</strong> ${this.formatDate(session.date)}<br>
                             <strong>D√©but:</strong> ${session.startTime}<br>
                             <strong>Lieu:</strong> ${session.locationName || 'Non sp√©cifi√©'}
                         </div>
                         <div>
                             <strong>M√©t√©o:</strong> ${session.weather || 'Non sp√©cifi√©'}<br>
                             <strong>Pr√©l√®vements:</strong> ${session.harvests.length}<br>
                             <strong>Observations:</strong> ${session.observations.length}
                         </div>
                     </div>
                     ${session.gpsTrack ? `<div style="margin-top: 0.5rem; color: #28a745; font-weight: 500;">‚úÖ Trajet GPS d√©j√† enregistr√©</div>` : ''}
                 `;
                 
                 infoDiv.style.display = 'block';
             }

             hideSessionInfo() {
                 document.getElementById('sessionInfo').style.display = 'none';
             }

             populateSessionSelector() {
                 const select = document.getElementById('trackingSession');
                 const currentValue = select.value;
                 
                 // Garder l'option par d√©faut
                 select.innerHTML = '<option value="">S√©lectionner une session</option>';
                 
                 // Ajouter les sessions sans trajet GPS ou avec trajet incomplet
                 this.sessions.forEach(session => {
                     const option = document.createElement('option');
                     option.value = session.id;
                     option.textContent = `${this.formatDate(session.date)} - ${session.locationName || 'Lieu non sp√©cifi√©'}`;
                     select.appendChild(option);
                 });
                 
                 // Restaurer la s√©lection si possible
                 if (currentValue && this.sessions.find(s => s.id === currentValue)) {
                     select.value = currentValue;
                     this.selectedSessionId = currentValue;
                     const session = this.sessions.find(s => s.id === currentValue);
                     if (session) {
                         this.displaySessionInfo(session);
                         document.getElementById('startTracking').disabled = false;
                     }
                 }
             }

                          startGPSTracking() {
                 if (!this.selectedSessionId) {
                     this.showNotification('Veuillez s√©lectionner une session de chasse');
                     return;
                 }

                 if (!navigator.geolocation) {
                     this.showNotification('G√©olocalisation non support√©e par votre navigateur');
                     return;
                 }

                this.isTracking = true;
                this.isPaused = false;
                this.trackingStartTime = Date.now();
                this.gpsTrack = [];

                // D√©marrer la surveillance GPS
                this.watchId = navigator.geolocation.watchPosition(
                    (position) => this.onPositionUpdate(position),
                    (error) => this.onPositionError(error),
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );

                // D√©marrer le timer d'affichage
                this.trackingInterval = setInterval(() => this.updateTrackingDisplay(), 1000);

                // Mettre √† jour l'interface
                this.updateTrackingUI();
                this.showNotification('Enregistrement GPS d√©marr√©');
            }

            pauseGPSTracking() {
                this.isPaused = !this.isPaused;
                this.updateTrackingUI();
                this.showNotification(this.isPaused ? 'Enregistrement en pause' : 'Enregistrement repris');
            }

            stopGPSTracking() {
                this.isTracking = false;
                this.isPaused = false;

                // Arr√™ter la surveillance GPS
                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }

                // Arr√™ter le timer
                if (this.trackingInterval) {
                    clearInterval(this.trackingInterval);
                    this.trackingInterval = null;
                }

                this.updateTrackingUI();
                this.showNotification('Enregistrement GPS arr√™t√©');
            }

            onPositionUpdate(position) {
                const { latitude, longitude, accuracy } = position.coords;
                const timestamp = Date.now();

                // Ajouter le point au trajet
                this.gpsTrack.push({
                    lat: latitude,
                    lng: longitude,
                    accuracy: accuracy,
                    timestamp: timestamp
                });

                // Mettre √† jour l'affichage
                this.updateTrackingDisplay();
                
                // Mettre √† jour la carte si elle est active
                if (this.leafletMap && this.gpsTrack.length > 1) {
                    this.updateTrackOnMap();
                }
            }

            onPositionError(error) {
                let errorMessage = 'Erreur GPS';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Permission GPS refus√©e';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Position GPS indisponible';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'D√©lai GPS d√©pass√©';
                        break;
                }
                this.showNotification(errorMessage);
            }

            updateTrackingDisplay() {
                if (!this.isTracking || this.isPaused) return;

                const now = Date.now();
                const duration = now - this.trackingStartTime;
                const distance = this.calculateTrackDistance();
                const speed = this.calculateAverageSpeed(duration, distance);

                // Mettre √† jour l'affichage
                document.getElementById('trackingDuration').textContent = this.formatDuration(duration);
                document.getElementById('trackingDistance').textContent = `${distance.toFixed(1)} km`;
                document.getElementById('trackingPoints').textContent = this.gpsTrack.length;
                document.getElementById('trackingSpeed').textContent = `${speed.toFixed(1)} km/h`;
            }

            updateTrackingUI() {
                const startBtn = document.getElementById('startTracking');
                const pauseBtn = document.getElementById('pauseTracking');
                const stopBtn = document.getElementById('stopTracking');
                const saveBtn = document.getElementById('saveTrack');
                const infoDiv = document.getElementById('trackingInfo');

                if (this.isTracking) {
                    startBtn.style.display = 'none';
                    pauseBtn.style.display = 'flex';
                    stopBtn.style.display = 'flex';
                    infoDiv.style.display = 'grid';

                    if (this.isPaused) {
                        pauseBtn.className = 'tracking-btn stopped';
                        pauseBtn.innerHTML = '<span>‚ñ∂Ô∏è</span><span>Reprendre</span>';
                    } else {
                        pauseBtn.className = 'tracking-btn recording';
                        pauseBtn.innerHTML = '<span>‚è∏Ô∏è</span><span>Pause</span>';
                    }

                    if (this.gpsTrack.length > 0) {
                        saveBtn.style.display = 'flex';
                    }
                } else {
                    startBtn.style.display = 'flex';
                    pauseBtn.style.display = 'none';
                    stopBtn.style.display = 'none';
                    saveBtn.style.display = 'none';
                    infoDiv.style.display = 'none';
                }
            }

            calculateTrackDistance() {
                if (this.gpsTrack.length < 2) return 0;

                let totalDistance = 0;
                for (let i = 1; i < this.gpsTrack.length; i++) {
                    const prev = this.gpsTrack[i - 1];
                    const curr = this.gpsTrack[i];
                    totalDistance += this.calculateDistance(prev.lat, prev.lng, curr.lat, curr.lng);
                }
                return totalDistance;
            }

            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371; // Rayon de la Terre en km
                const dLat = this.toRadians(lat2 - lat1);
                const dLng = this.toRadians(lng2 - lng1);
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                         Math.cos(this.toRadians(lat1)) * Math.cos(this.toRadians(lat2)) *
                         Math.sin(dLng / 2) * Math.sin(dLng / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            toRadians(degrees) {
                return degrees * (Math.PI / 180);
            }

            calculateAverageSpeed(durationMs, distanceKm) {
                if (durationMs === 0) return 0;
                const durationHours = durationMs / (1000 * 60 * 60);
                return distanceKm / durationHours;
            }

            formatDuration(ms) {
                const seconds = Math.floor(ms / 1000);
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

                         saveGPSTrack() {
                 if (this.gpsTrack.length === 0) {
                     this.showNotification('Aucun trajet √† sauvegarder');
                     return;
                 }

                 if (!this.selectedSessionId) {
                     this.showNotification('Aucune session s√©lectionn√©e');
                     return;
                 }

                 // Trouver la session
                 const session = this.sessions.find(s => s.id === this.selectedSessionId);
                 if (!session) {
                     this.showNotification('Session introuvable');
                     return;
                 }

                 // Cr√©er les donn√©es du trajet
                 const trackData = {
                     points: this.gpsTrack,
                     startTime: this.trackingStartTime,
                     endTime: Date.now(),
                     distance: this.calculateTrackDistance(),
                     duration: this.trackingStartTime ? Date.now() - this.trackingStartTime : 0
                 };

                 // Ajouter le trajet √† la session
                 session.gpsTrack = trackData;
                 
                 // Sauvegarder les sessions
                    this.saveToStorage();
                 
                 // Mettre √† jour l'affichage
                    this.renderSessions();
                 this.populateSessionSelector();
                 
                 this.showNotification('Trajet GPS sauvegard√© dans la session');
                 
                 // R√©initialiser le tracking
                 this.stopGPSTracking();
                 this.gpsTrack = [];
                 
                 // Mettre √† jour l'affichage des trajets sauvegard√©s
                 this.renderSavedTracksList();
             }

            updateTrackOnMap() {
                if (!this.leafletMap || this.gpsTrack.length < 2) return;

                // Supprimer l'ancien trajet
                if (this.trackLayer) {
                    this.leafletMap.removeLayer(this.trackLayer);
                }

                // Cr√©er le nouveau trajet
                const trackPoints = this.gpsTrack.map(point => [point.lat, point.lng]);
                this.trackLayer = L.polyline(trackPoints, {
                    color: '#2c5530',
                    weight: 4,
                    opacity: 0.8
                }).addTo(this.leafletMap);

                // Ajouter un marqueur pour la position actuelle
                const lastPoint = this.gpsTrack[this.gpsTrack.length - 1];
                if (this.currentPositionMarker) {
                    this.leafletMap.removeLayer(this.currentPositionMarker);
                }
                                 this.currentPositionMarker = L.circleMarker([lastPoint.lat, lastPoint.lng], {
                     radius: 8,
                     fillColor: '#2c5530',
                     color: 'white',
                     weight: 2,
                     opacity: 1,
                     fillOpacity: 0.8
                 }).addTo(this.leafletMap);
             }

             // M√©thodes pour les points d'int√©r√™t
             addPointOfInterest(e) {
                 e.preventDefault();
                 
                 // Obtenir la position actuelle
                 if (!navigator.geolocation) {
                     this.showNotification('G√©olocalisation non support√©e');
                     return;
                 }

                 navigator.geolocation.getCurrentPosition(
                     (position) => {
                         const { latitude, longitude } = position.coords;
                         const poiName = document.getElementById('poiName').value;
                         const poiType = document.getElementById('poiType').value;

                         const poi = {
                             id: Date.now().toString(),
                             name: poiName,
                             type: poiType,
                             lat: latitude,
                             lng: longitude,
                             createdAt: new Date().toISOString()
                         };

                         this.pointsOfInterest.push(poi);
                         this.savePOI();
                         this.renderPOIList();
                         this.addPOIToMap(poi);

                         // R√©initialiser le formulaire
                         document.getElementById('poiForm').reset();
                         this.showNotification('Point d\'int√©r√™t ajout√©');
                     },
                     (error) => {
                         this.showNotification('Erreur lors de la r√©cup√©ration de la position');
                     }
                 );
             }

             renderPOIList() {
                 const container = document.getElementById('poiList');
                 
                 if (this.pointsOfInterest.length === 0) {
                     container.innerHTML = '<p style="color: #6c757d; font-style: italic; text-align: center;">Aucun point d\'int√©r√™t enregistr√©</p>';
                     return;
                 }
                 
                 container.innerHTML = this.pointsOfInterest.map(poi => `
                     <div class="poi-item">
                         <div class="poi-info">
                             <h4>${poi.name}</h4>
                             <p>${this.getPOITypeLabel(poi.type)} ‚Ä¢ ${new Date(poi.createdAt).toLocaleDateString('fr-FR')}</p>
                         </div>
                         <div class="poi-actions">
                             <button class="poi-btn view" onclick="huntingTracker.viewPOIOnMap('${poi.id}')">
                                 üó∫Ô∏è Voir
                             </button>
                             <button class="poi-btn delete" onclick="huntingTracker.deletePOI('${poi.id}')">
                                 üóëÔ∏è
                             </button>
                         </div>
                     </div>
                 `).join('');
             }

             getPOITypeLabel(type) {
                 const labels = {
                     'poste': 'Poste de chasse',
                     'eau': 'Point d\'eau',
                     'passage': 'Passage de gibier',
                     'nourrissage': 'Zone de nourrissage',
                     'repos': 'Zone de repos',
                     'autre': 'Autre'
                 };
                 return labels[type] || 'Autre';
             }

             addPOIToMap(poi) {
                 if (!this.leafletMap) return;

                 const icon = L.divIcon({
                     className: 'custom-poi-marker',
                     html: `<div style="
                         width: 20px; 
                         height: 20px; 
                         background-color: #ffc107; 
                         border: 3px solid #212529; 
                         border-radius: 50%; 
                         box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                         display: flex;
                         align-items: center;
                         justify-content: center;
                         font-size: 12px;
                         color: #212529;
                         font-weight: bold;
                     ">üìç</div>`,
                     iconSize: [20, 20],
                     iconAnchor: [10, 10]
                 });

                 const marker = L.marker([poi.lat, poi.lng], { icon: icon })
                     .bindPopup(`
                         <div style="min-width: 200px;">
                             <h3>${poi.name}</h3>
                             <p><strong>Type:</strong> ${this.getPOITypeLabel(poi.type)}</p>
                             <p><strong>Ajout√© le:</strong> ${new Date(poi.createdAt).toLocaleDateString('fr-FR')}</p>
                         </div>
                     `)
                     .addTo(this.leafletMap);

                 // Stocker la r√©f√©rence du marqueur
                 if (!this.poiMarkers) this.poiMarkers = {};
                 this.poiMarkers[poi.id] = marker;
             }

             viewPOIOnMap(poiId) {
                 const poi = this.pointsOfInterest.find(p => p.id === poiId);
                 if (!poi || !this.leafletMap) return;

                 this.leafletMap.setView([poi.lat, poi.lng], 16);
                 
                 // Ouvrir la popup du marqueur
                 if (this.poiMarkers && this.poiMarkers[poiId]) {
                     this.poiMarkers[poiId].openPopup();
                 }
             }

             deletePOI(poiId) {
                 if (confirm('√ätes-vous s√ªr de vouloir supprimer ce point d\'int√©r√™t ?')) {
                     // Supprimer de la liste
                     this.pointsOfInterest = this.pointsOfInterest.filter(p => p.id !== poiId);
                     
                     // Supprimer de la carte
                     if (this.poiMarkers && this.poiMarkers[poiId]) {
                         this.leafletMap.removeLayer(this.poiMarkers[poiId]);
                         delete this.poiMarkers[poiId];
                     }
                     
                     // Sauvegarder et mettre √† jour l'affichage
                     this.savePOI();
                     this.renderPOIList();
                     this.showNotification('Point d\'int√©r√™t supprim√©');
                 }
             }

             savePOI() {
                 localStorage.setItem('huntingPOI', JSON.stringify(this.pointsOfInterest));
             }

             loadPOIOnMap() {
                 if (!this.leafletMap) return;
                 
                 this.pointsOfInterest.forEach(poi => {
                     this.addPOIToMap(poi);
                 });
             }

             loadSessionTracksOnMap() {
                 if (!this.leafletMap) return;
                 
                 // Supprimer les anciens trajets
                 if (this.sessionTrackLayers) {
                     this.sessionTrackLayers.forEach(layer => {
                         this.leafletMap.removeLayer(layer);
                     });
                 }
                 
                 this.sessionTrackLayers = [];
                 
                 // Ajouter les trajets des sessions
                  this.sessions.forEach(session => {
                     if (session.gpsTrack && session.gpsTrack.points && session.gpsTrack.points.length > 1) {
                         const trackPoints = session.gpsTrack.points.map(point => [point.lat, point.lng]);
                         const trackLayer = L.polyline(trackPoints, {
                             color: '#2c5530',
                             weight: 3,
                             opacity: 0.6
                         }).bindPopup(`
                             <div style="min-width: 200px;">
                                 <h3>Trajet GPS - ${this.formatDate(session.date)}</h3>
                                 <p><strong>Lieu:</strong> ${session.locationName || 'Non sp√©cifi√©'}</p>
                                 <p><strong>Distance:</strong> ${session.gpsTrack.distance ? session.gpsTrack.distance.toFixed(1) : '0'} km</p>
                                 <p><strong>Dur√©e:</strong> ${session.gpsTrack.duration ? this.formatDuration(session.gpsTrack.duration) : 'Non calcul√©e'}</p>
                             </div>
                         `);
                         
                         trackLayer.addTo(this.leafletMap);
                         this.sessionTrackLayers.push(trackLayer);
                     }
                 });
             }

             // M√©thodes pour les trajets sauvegard√©s
             renderSavedTracksList() {
                 const container = document.getElementById('savedTracksList');
                 
                 // R√©cup√©rer les sessions avec trajets GPS
                 const sessionsWithTracks = this.sessions.filter(session => session.gpsTrack);
                 
                 if (sessionsWithTracks.length === 0) {
                     container.innerHTML = '<p style="color: #6c757d; font-style: italic; text-align: center;">Aucun trajet GPS enregistr√©</p>';
                     return;
                 }

                 container.innerHTML = sessionsWithTracks.map(session => `
                     <div class="poi-item">
                         <div class="poi-info">
                             <h4>${this.formatDate(session.date)} - ${session.locationName || 'Lieu non sp√©cifi√©'}</h4>
                             <p>Distance: ${session.gpsTrack.distance ? session.gpsTrack.distance.toFixed(1) : '0'} km ‚Ä¢ 
                                Dur√©e: ${session.gpsTrack.duration ? this.formatDuration(session.gpsTrack.duration) : 'Non calcul√©e'}</p>
                         </div>
                         <div class="poi-actions">
                             <button class="poi-btn view" onclick="huntingTracker.viewSessionTrackOnMap('${session.id}')">
                                 üó∫Ô∏è Voir
                             </button>
                             <button class="poi-btn delete" onclick="huntingTracker.deleteSessionTrack('${session.id}')">
                                 üóëÔ∏è
                             </button>
                         </div>
                     </div>
                 `).join('');
             }

             viewTrackOnMap(trackId) {
                 const savedTracks = JSON.parse(localStorage.getItem('huntingTracks')) || [];
                 const track = savedTracks.find(t => t.id === trackId);
                 
                 if (!track || !this.leafletMap) return;

                 // Supprimer l'ancien trajet affich√©
                 if (this.displayedTrack) {
                     this.leafletMap.removeLayer(this.displayedTrack);
                 }

                 // Afficher le nouveau trajet
                 const trackPoints = track.points.map(point => [point.lat, point.lng]);
                 this.displayedTrack = L.polyline(trackPoints, {
                     color: '#2c5530',
                     weight: 4,
                     opacity: 0.8
                 }).addTo(this.leafletMap);

                 // Ajuster la vue pour inclure tout le trajet
                 const bounds = L.latLngBounds(trackPoints);
                 this.leafletMap.fitBounds(bounds, { padding: [20, 20] });

                 this.showNotification('Trajet affich√© sur la carte');
             }

             viewSessionTrackOnMap(sessionId) {
                 const session = this.sessions.find(s => s.id === sessionId);
                 
                 if (!session || !session.gpsTrack || !this.leafletMap) return;

                 // Supprimer l'ancien trajet affich√©
                 if (this.displayedTrack) {
                     this.leafletMap.removeLayer(this.displayedTrack);
                 }

                 // Afficher le nouveau trajet
                 const trackPoints = session.gpsTrack.points.map(point => [point.lat, point.lng]);
                 this.displayedTrack = L.polyline(trackPoints, {
                     color: '#2c5530',
                     weight: 4,
                     opacity: 0.8
                 }).addTo(this.leafletMap);

                 // Ajuster la vue pour inclure tout le trajet
                 const bounds = L.latLngBounds(trackPoints);
                 this.leafletMap.fitBounds(bounds, { padding: [20, 20] });

                 this.showNotification(`Trajet de la session du ${this.formatDate(session.date)} affich√©`);
             }

             deleteSessionTrack(sessionId) {
                 if (confirm('√ätes-vous s√ªr de vouloir supprimer le trajet GPS de cette session ?')) {
                     const session = this.sessions.find(s => s.id === sessionId);
                     if (session) {
                         delete session.gpsTrack;
                         this.saveToStorage();
                         this.renderSessions();
                         this.renderSavedTracksList();
                         this.populateSessionSelector();
                         this.showNotification('Trajet GPS supprim√© de la session');
                     }
                 }
             }

             // M√©thodes pour les graphiques avanc√©s
             initAdvancedCharts() {
                 // Attendre que le DOM soit pr√™t
                 setTimeout(() => {
                     this.createSpeciesChart();
                     this.createTimelineChart();
                     this.createWeatherChart();
                     this.createActivityChart();
                 }, 100);
             }

             onChartFilterClick(e) {
                 const filter = e.target;
                 const container = filter.closest('.chart-container');
                 const filters = container.querySelectorAll('.chart-filter');
                 
                 // Mettre √† jour les classes actives
                 filters.forEach(f => f.classList.remove('active'));
                 filter.classList.add('active');
                 
                 // Mettre √† jour le graphique correspondant
                 if (container.querySelector('#speciesChart')) {
                     this.currentChartFilters.species = filter.dataset.filter;
                     this.updateSpeciesChart();
                 } else if (container.querySelector('#timelineChart')) {
                     this.currentChartFilters.timeline = filter.dataset.period;
                     this.updateTimelineChart();
                 }
             }

             createSpeciesChart() {
                 const ctx = document.getElementById('speciesChart');
                 if (!ctx) return;

                 this.charts.species = new Chart(ctx, {
                     type: 'bar',
                     data: this.getSpeciesChartData(),
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         plugins: {
                             legend: {
                                 display: true,
                                 position: 'top'
                             }
                         },
                         scales: {
                             y: {
                                 beginAtZero: true,
                                 title: {
                                     display: true,
                                     text: 'Nombre'
                                 }
                             }
                          }
                      }
                  });
             }
                 
             getSpeciesChartData() {
                 const speciesData = {};
                 
                  this.sessions.forEach(session => {
                     if (this.currentChartFilters.species === 'harvests' || this.currentChartFilters.species === 'both') {
                      session.harvests.forEach(harvest => {
                             const species = harvest.type;
                             if (!speciesData[species]) {
                                 speciesData[species] = { harvests: 0, observations: 0 };
                             }
                             speciesData[species].harvests++;
                         });
                     }
                     
                     if (this.currentChartFilters.species === 'observations' || this.currentChartFilters.species === 'both') {
                         session.observations.forEach(obs => {
                             const species = obs.type;
                             if (!speciesData[species]) {
                                 speciesData[species] = { harvests: 0, observations: 0 };
                             }
                             speciesData[species].observations++;
                         });
                     }
                 });

                 const labels = Object.keys(speciesData);
                 const harvestData = labels.map(species => speciesData[species].harvests);
                 const observationData = labels.map(species => speciesData[species].observations);

                 return {
                     labels: labels,
                     datasets: [
                         {
                             label: 'Pr√©l√®vements',
                             data: harvestData,
                             backgroundColor: '#dc3545',
                             borderColor: '#c82333',
                             borderWidth: 1
                         },
                         {
                             label: 'Observations',
                             data: observationData,
                             backgroundColor: '#ffc107',
                             borderColor: '#e0a800',
                             borderWidth: 1
                         }
                     ]
                 };
             }

             updateSpeciesChart() {
                 if (this.charts.species) {
                     this.charts.species.data = this.getSpeciesChartData();
                     this.charts.species.update();
                 }
             }

             createTimelineChart() {
                 const ctx = document.getElementById('timelineChart');
                 if (!ctx) return;

                 this.charts.timeline = new Chart(ctx, {
                     type: 'line',
                     data: this.getTimelineChartData(),
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         plugins: {
                             legend: {
                                 display: true,
                                 position: 'top'
                             }
                         },
                         scales: {
                             y: {
                                 beginAtZero: true,
                                 title: {
                                     display: true,
                                     text: 'Nombre'
                                 }
                             }
                              }
                          }
                      });
             }

             getTimelineChartData() {
                 const timelineData = {};
                 const period = this.currentChartFilters.timeline;
                 
                 this.sessions.forEach(session => {
                     const date = new Date(session.date);
                     let key;
                     
                     if (period === 'months') {
                         key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                     } else if (period === 'weeks') {
                         const weekNumber = Math.ceil((date.getDate() + new Date(date.getFullYear(), date.getMonth(), 1).getDay()) / 7);
                         key = `${date.getFullYear()}-W${weekNumber.toString().padStart(2, '0')}`;
                     } else {
                         key = session.date;
                     }
                     
                     if (!timelineData[key]) {
                         timelineData[key] = { harvests: 0, observations: 0, sessions: 0 };
                     }
                     
                     timelineData[key].harvests += session.harvests.length;
                     timelineData[key].observations += session.observations.length;
                     timelineData[key].sessions++;
                 });

                 const labels = Object.keys(timelineData).sort();
                 const harvestData = labels.map(key => timelineData[key].harvests);
                 const observationData = labels.map(key => timelineData[key].observations);

                 return {
                     labels: labels,
                     datasets: [
                         {
                             label: 'Pr√©l√®vements',
                             data: harvestData,
                             borderColor: '#dc3545',
                             backgroundColor: 'rgba(220, 53, 69, 0.1)',
                             tension: 0.1
                         },
                         {
                             label: 'Observations',
                             data: observationData,
                             borderColor: '#ffc107',
                             backgroundColor: 'rgba(255, 193, 7, 0.1)',
                             tension: 0.1
                         }
                     ]
                 };
             }

             updateTimelineChart() {
                 if (this.charts.timeline) {
                     this.charts.timeline.data = this.getTimelineChartData();
                     this.charts.timeline.update();
                 }
             }

             createWeatherChart() {
                 const ctx = document.getElementById('weatherChart');
                 if (!ctx) return;

                 const weatherData = {};
                 
                 this.sessions.forEach(session => {
                     const weather = session.weather || 'Non sp√©cifi√©';
                     if (!weatherData[weather]) {
                         weatherData[weather] = { sessions: 0, harvests: 0, efficiency: 0 };
                     }
                     
                     const hours = this.calculateHours(session.startTime, session.endTime);
                     weatherData[weather].sessions++;
                     weatherData[weather].harvests += session.harvests.length;
                     weatherData[weather].efficiency += hours > 0 ? session.harvests.length / hours : 0;
                 });

                 // Calculer l'efficacit√© moyenne
                 Object.keys(weatherData).forEach(weather => {
                     weatherData[weather].efficiency = weatherData[weather].sessions > 0 ? 
                         weatherData[weather].efficiency / weatherData[weather].sessions : 0;
                 });

                 const labels = Object.keys(weatherData);
                 const efficiencyData = labels.map(weather => weatherData[weather].efficiency);

                 this.charts.weather = new Chart(ctx, {
                     type: 'doughnut',
                     data: {
                         labels: labels,
                         datasets: [{
                             data: efficiencyData,
                             backgroundColor: [
                                 '#28a745', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#6c757d'
                             ],
                             borderWidth: 2,
                             borderColor: '#fff'
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         plugins: {
                             legend: {
                                 position: 'bottom'
                             },
                             tooltip: {
                                 callbacks: {
                                     label: function(context) {
                                         return `${context.label}: ${context.parsed.toFixed(2)} pr√©l√®vements/h`;
                                     }
                                 }
                             }
                              }
                          }
                      });
             }

             createActivityChart() {
                 const ctx = document.getElementById('activityChart');
                 if (!ctx) return;

                 const activityData = {
                     'Sessions': this.sessions.length,
                     'Pr√©l√®vements': this.sessions.reduce((sum, session) => sum + session.harvests.length, 0),
                     'Observations': this.sessions.reduce((sum, session) => sum + session.observations.length, 0),
                     'Trajets GPS': this.sessions.filter(session => session.gpsTrack).length
                 };

                 this.charts.activity = new Chart(ctx, {
                     type: 'pie',
                     data: {
                         labels: Object.keys(activityData),
                         datasets: [{
                             data: Object.values(activityData),
                             backgroundColor: [
                                 '#007bff', '#dc3545', '#ffc107', '#28a745'
                             ],
                             borderWidth: 2,
                             borderColor: '#fff'
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         plugins: {
                             legend: {
                                 position: 'bottom'
                             }
                         }
                     }
                 });
             }





            saveHarvest(e) {
                e.preventDefault();
                
                if (!this.currentSessionId) return;
                
                const formData = new FormData(e.target);
                const session = this.sessions.find(s => s.id === this.currentSessionId);
                
                if (!session) return;
                
                                 const item = {
                     id: Date.now().toString(),
                     type: formData.get('harvestType'),
                     time: formData.get('harvestTime'),
                     notes: formData.get('harvestNotes'),
                     locationName: formData.get('harvestLocationName') || null,
                     locationGPS: formData.get('harvestLocation') || null,
                     images: this.selectedImages, // Ajouter les images
                     createdAt: new Date().toISOString()
                 };
                
                // Ajouter les coordonn√©es GPS si disponibles
                if (this.harvestGPS) {
                    item.gps = this.harvestGPS;
                    this.harvestGPS = null; // R√©initialiser pour le prochain enregistrement
                }
                
                if (this.isHarvestMode) {
                    item.weight = formData.get('harvestWeight') || null;
                    session.harvests.push(item);
                } else {
                    item.count = formData.get('harvestCount') || null;
                    session.observations.push(item);
                }
                
                this.saveToStorage();
                this.closeHarvestModal();
                this.openSessionDetails(this.currentSessionId); // Recharger les d√©tails
                
                this.showNotification(
                    this.isHarvestMode ? 'Pr√©l√®vement ajout√© !' : 'Observation ajout√©e !'
                );
            }

            deleteSession() {
                if (!this.currentSessionId) return;
                
                if (confirm('√ätes-vous s√ªr de vouloir supprimer cette session ?')) {
                    this.sessions = this.sessions.filter(s => s.id !== this.currentSessionId);
                    this.saveToStorage();
                    this.renderSessions();
                    this.closeDetailsModal();
                    this.showNotification('Session supprim√©e');
                }
            }

                         updateStats() {
                 const totalSessions = this.sessions.length;
                 let totalHours = 0;
                 let totalHarvests = 0;
                 let totalObservations = 0;
                 let completedSessions = 0;
                 
                 this.sessions.forEach(session => {
                     const hours = this.calculateHours(session.startTime, session.endTime);
                     totalHours += hours;
                     totalHarvests += session.harvests.length;
                     totalObservations += session.observations.length;
                     if (session.endTime) completedSessions++;
                 });
                 
                 // Statistiques de base
                 document.getElementById('totalSessions').textContent = totalSessions;
                 document.getElementById('totalHours').textContent = `${totalHours}h`;
                 document.getElementById('totalHarvests').textContent = totalHarvests;
                 document.getElementById('totalObservations').textContent = totalObservations;
                 
                 // Dur√©e moyenne
                 const avgDuration = completedSessions > 0 ? totalHours / completedSessions : 0;
                 document.getElementById('avgDuration').textContent = `${avgDuration.toFixed(1)}h`;
                 
                 // Efficacit√© (pr√©l√®vements par heure)
                 const efficiency = totalHours > 0 ? (totalHarvests / totalHours * 100) : 0;
                 document.getElementById('efficiency').textContent = `${efficiency.toFixed(1)}%`;
                 
                 // Graphiques avanc√©s
                 this.initAdvancedCharts();
             }




             
             // Statistiques par esp√®ce
             updateSpeciesStats() {
                 const speciesData = {};
                 
                 // Compter les pr√©l√®vements par esp√®ce
                 this.sessions.forEach(session => {
                     session.harvests.forEach(harvest => {
                         const species = harvest.type;
                         if (!speciesData[species]) {
                             speciesData[species] = { harvests: 0, observations: 0 };
                         }
                         speciesData[species].harvests++;
                     });
                     
                     session.observations.forEach(obs => {
                         const species = obs.type;
                         if (!speciesData[species]) {
                             speciesData[species] = { harvests: 0, observations: 0 };
                         }
                         speciesData[species].observations++;
                     });
                 });
                 
                 const container = document.getElementById('speciesStats');
                 if (Object.keys(speciesData).length === 0) {
                     container.innerHTML = '<div class="empty-stats">Aucune donn√©e disponible</div>';
                     return;
                 }
                 
                 const maxHarvests = Math.max(...Object.values(speciesData).map(d => d.harvests));
                 
                 container.innerHTML = Object.entries(speciesData)
                     .sort((a, b) => b[1].harvests - a[1].harvests)
                     .map(([species, data]) => {
                         const percentage = maxHarvests > 0 ? (data.harvests / maxHarvests * 100) : 0;
                         return `
                             <div class="stat-item-detailed">
                                 <h4>${species}</h4>
                                 <div class="stat-numbers">
                                     <span>üèπ ${data.harvests} pr√©l√®vements</span>
                                     <span>üëÅÔ∏è ${data.observations} observations</span>
                                 </div>
                                 <div class="stat-bar">
                                     <div class="stat-bar-fill" style="width: ${percentage}%"></div>
                                 </div>
                             </div>
                         `;
                     }).join('');
             }
             
             // Statistiques par mois
             updateMonthlyStats() {
                 const monthlyData = {};
                 
                 this.sessions.forEach(session => {
                     const date = new Date(session.date);
                     const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                     const monthName = date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' });
                     
                     if (!monthlyData[monthKey]) {
                         monthlyData[monthKey] = {
                             name: monthName,
                             sessions: 0,
                             harvests: 0,
                             observations: 0,
                             hours: 0
                         };
                     }
                     
                     monthlyData[monthKey].sessions++;
                     monthlyData[monthKey].harvests += session.harvests.length;
                     monthlyData[monthKey].observations += session.observations.length;
                     monthlyData[monthKey].hours += this.calculateHours(session.startTime, session.endTime);
                 });
                 
                 const container = document.getElementById('monthlyStats');
                 if (Object.keys(monthlyData).length === 0) {
                     container.innerHTML = '<div class="empty-stats">Aucune donn√©e disponible</div>';
                     return;
                 }
                 
                 const maxSessions = Math.max(...Object.values(monthlyData).map(d => d.sessions));
                 
                 container.innerHTML = Object.entries(monthlyData)
                     .sort((a, b) => a[0].localeCompare(b[0]))
                     .map(([key, data]) => {
                         const percentage = maxSessions > 0 ? (data.sessions / maxSessions * 100) : 0;
                         return `
                             <div class="stat-item-detailed">
                                 <h4>${data.name}</h4>
                                 <div class="stat-numbers">
                                     <span>üìÖ ${data.sessions} sessions</span>
                                     <span>üèπ ${data.harvests} pr√©l√®vements</span>
                                     <span>üëÅÔ∏è ${data.observations} observations</span>
                                     <span>‚è±Ô∏è ${data.hours.toFixed(1)}h</span>
                                 </div>
                                 <div class="stat-bar">
                                     <div class="stat-bar-fill" style="width: ${percentage}%"></div>
                                 </div>
                             </div>
                         `;
                     }).join('');
             }
             
             // Statistiques par m√©t√©o
             updateWeatherStats() {
                 const weatherData = {};
                 
                 this.sessions.forEach(session => {
                     const weather = session.weather || 'Non sp√©cifi√©';
                     if (!weatherData[weather]) {
                         weatherData[weather] = {
                             sessions: 0,
                             harvests: 0,
                             observations: 0,
                             hours: 0
                         };
                     }
                     
                     weatherData[weather].sessions++;
                     weatherData[weather].harvests += session.harvests.length;
                     weatherData[weather].observations += session.observations.length;
                     weatherData[weather].hours += this.calculateHours(session.startTime, session.endTime);
                 });
                 
                 const container = document.getElementById('weatherStats');
                 if (Object.keys(weatherData).length === 0) {
                     container.innerHTML = '<div class="empty-stats">Aucune donn√©e disponible</div>';
                     return;
                 }
                 
                 const maxHarvests = Math.max(...Object.values(weatherData).map(d => d.harvests));
                 
                 container.innerHTML = Object.entries(weatherData)
                     .sort((a, b) => b[1].harvests - a[1].harvests)
                     .map(([weather, data]) => {
                         const percentage = maxHarvests > 0 ? (data.harvests / maxHarvests * 100) : 0;
                         const efficiency = data.hours > 0 ? (data.harvests / data.hours) : 0;
                         
                         const weatherIcon = this.getWeatherIcon(weather);
                         
                         return `
                             <div class="stat-item-detailed">
                                 <h4>${weatherIcon} ${weather}</h4>
                                 <div class="stat-numbers">
                                     <span>üìÖ ${data.sessions} sessions</span>
                                     <span>üèπ ${data.harvests} pr√©l√®vements</span>
                                     <span>üëÅÔ∏è ${data.observations} observations</span>
                                     <span>üìä ${efficiency.toFixed(2)} pr√©l√®vements/h</span>
                                 </div>
                                 <div class="stat-bar">
                                     <div class="stat-bar-fill" style="width: ${percentage}%"></div>
                                 </div>
                             </div>
                         `;
                     }).join('');
             }
             
             // Statistiques par lieu
             updateLocationStats() {
                 const locationData = {};
                 
                 this.sessions.forEach(session => {
                     const location = session.locationName || 'Lieu non sp√©cifi√©';
                     if (!locationData[location]) {
                         locationData[location] = {
                             sessions: 0,
                             harvests: 0,
                             observations: 0,
                             hours: 0
                         };
                     }
                     
                     locationData[location].sessions++;
                     locationData[location].harvests += session.harvests.length;
                     locationData[location].observations += session.observations.length;
                     locationData[location].hours += this.calculateHours(session.startTime, session.endTime);
                 });
                 
                 const container = document.getElementById('locationStats');
                 if (Object.keys(locationData).length === 0) {
                     container.innerHTML = '<div class="empty-stats">Aucune donn√©e disponible</div>';
                     return;
                 }
                 
                 const maxHarvests = Math.max(...Object.values(locationData).map(d => d.harvests));
                 
                 container.innerHTML = Object.entries(locationData)
                     .sort((a, b) => b[1].harvests - a[1].harvests)
                     .slice(0, 5) // Top 5 des lieux
                     .map(([location, data]) => {
                         const percentage = maxHarvests > 0 ? (data.harvests / maxHarvests * 100) : 0;
                         const efficiency = data.hours > 0 ? (data.harvests / data.hours) : 0;
                         
                         return `
                             <div class="stat-item-detailed">
                                 <h4>üìç ${location}</h4>
                                 <div class="stat-numbers">
                                     <span>üìÖ ${data.sessions} sessions</span>
                                     <span>üèπ ${data.harvests} pr√©l√®vements</span>
                                     <span>üëÅÔ∏è ${data.observations} observations</span>
                                     <span>üìä ${efficiency.toFixed(2)} pr√©l√®vements/h</span>
                                 </div>
                                 <div class="stat-bar">
                                     <div class="stat-bar-fill" style="width: ${percentage}%"></div>
                                 </div>
                             </div>
                         `;
                     }).join('');
             }
             
             // Graphique d'activit√©
             updateActivityChart() {
                 const container = document.getElementById('activityChart');
                 
                 if (this.sessions.length === 0) {
                     container.innerHTML = '<div class="empty-stats">Aucune donn√©e disponible</div>';
                     return;
                 }
                 
                 // Cr√©er un graphique simple avec des barres
                 const canvas = document.createElement('canvas');
                 canvas.className = 'chart-canvas';
                 container.innerHTML = '';
                 container.appendChild(canvas);
                 
                 const ctx = canvas.getContext('2d');
                 const width = container.offsetWidth - 40;
                 const height = 280;
                 canvas.width = width;
                 canvas.height = height;
                 
                 // Donn√©es des 12 derniers mois
                 const months = [];
                 const harvestData = [];
                 const observationData = [];
                 
                 const now = new Date();
                 for (let i = 11; i >= 0; i--) {
                     const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                     const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                     const monthName = date.toLocaleDateString('fr-FR', { month: 'short' });
                     
                     months.push(monthName);
                     
                     let harvests = 0;
                     let observations = 0;
                     
                     this.sessions.forEach(session => {
                         const sessionDate = new Date(session.date);
                         const sessionMonthKey = `${sessionDate.getFullYear()}-${(sessionDate.getMonth() + 1).toString().padStart(2, '0')}`;
                         
                         if (sessionMonthKey === monthKey) {
                             harvests += session.harvests.length;
                             observations += session.observations.length;
                         }
                     });
                     
                     harvestData.push(harvests);
                     observationData.push(observations);
                 }
                 
                 const maxValue = Math.max(...harvestData, ...observationData);
                 const barWidth = width / months.length - 10;
                 const barSpacing = 10;
                 
                 // Dessiner les axes
                 ctx.strokeStyle = '#6c757d';
                 ctx.lineWidth = 1;
                 ctx.beginPath();
                 ctx.moveTo(30, 20);
                 ctx.lineTo(30, height - 30);
                 ctx.lineTo(width - 10, height - 30);
                 ctx.stroke();
                 
                 // Dessiner les barres
                 months.forEach((month, index) => {
                     const x = 40 + index * (barWidth + barSpacing);
                     const harvestHeight = maxValue > 0 ? (harvestData[index] / maxValue) * (height - 80) : 0;
                     const observationHeight = maxValue > 0 ? (observationData[index] / maxValue) * (height - 80) : 0;
                     
                     // Barre des pr√©l√®vements
                     ctx.fillStyle = '#dc3545';
                     ctx.fillRect(x, height - 30 - harvestHeight, barWidth / 2, harvestHeight);
                     
                     // Barre des observations
                     ctx.fillStyle = '#ffc107';
                     ctx.fillRect(x + barWidth / 2, height - 30 - observationHeight, barWidth / 2, observationHeight);
                     
                     // Texte du mois
                     ctx.fillStyle = '#495057';
                     ctx.font = '12px Arial';
                     ctx.textAlign = 'center';
                     ctx.fillText(month, x + barWidth / 2, height - 10);
                 });
                 
                 // L√©gende
                 ctx.fillStyle = '#dc3545';
                 ctx.fillRect(10, 10, 15, 15);
                 ctx.fillStyle = '#495057';
                 ctx.font = '12px Arial';
                 ctx.textAlign = 'left';
                 ctx.fillText('Pr√©l√®vements', 30, 20);
                 
                 ctx.fillStyle = '#ffc107';
                 ctx.fillRect(10, 30, 15, 15);
                 ctx.fillStyle = '#495057';
                 ctx.fillText('Observations', 30, 40);
             }
             
             // Helper pour les ic√¥nes m√©t√©o
             getWeatherIcon(weather) {
                 const icons = {
                     'ensoleill√©': '‚òÄÔ∏è',
                     'nuageux': '‚òÅÔ∏è',
                     'pluvieux': 'üåßÔ∏è',
                     'neigeux': '‚ùÑÔ∏è',
                     'venteux': 'üí®',
                     'Non sp√©cifi√©': '‚ùì'
                 };
                 return icons[weather] || '‚ùì';
             }
             
             // M√©thodes pour la carte
             updateMap() {
                 // Nettoyer l'ancienne carte si elle existe
                 const container = document.getElementById('mapCanvas');
                 if (container && container.mapInstance) {
                     container.mapInstance.remove();
                     container.mapInstance = null;
                 }
                 
                 this.populateSpeciesFilter();
                 this.renderMap();
             }
             
             populateSpeciesFilter() {
                 const select = document.getElementById('speciesFilter');
                 const species = new Set();
                 
                 // Collecter toutes les esp√®ces
                 this.sessions.forEach(session => {
                     session.harvests.forEach(harvest => species.add(harvest.type));
                     session.observations.forEach(obs => species.add(obs.type));
                 });
                 
                 // Garder l'option "Toutes les esp√®ces" et ajouter les nouvelles
                 const currentValue = select.value;
                 select.innerHTML = '<option value="all">Toutes les esp√®ces</option>';
                 
                 Array.from(species).sort().forEach(speciesName => {
                     const option = document.createElement('option');
                     option.value = speciesName;
                     option.textContent = speciesName;
                     select.appendChild(option);
                 });
                 
                 // Restaurer la s√©lection pr√©c√©dente si possible
                 if (currentValue && Array.from(species).includes(currentValue)) {
                     select.value = currentValue;
                 }
             }
             
             renderMap() {
                 const container = document.getElementById('mapCanvas');
                 const selectedSpecies = document.getElementById('speciesFilter').value;
                 const showHarvests = document.getElementById('showHarvests').checked;
                 const showObservations = document.getElementById('showObservations').checked;
                 
                 // Collecter les points GPS
                 const points = [];
                 
                 this.sessions.forEach(session => {
                     // Pr√©l√®vements
                     if (showHarvests) {
                         session.harvests.forEach(harvest => {
                             if (selectedSpecies === 'all' || harvest.type === selectedSpecies) {
                                 if (harvest.gps) {
                                     points.push({
                                         lat: harvest.gps.latitude,
                                         lng: harvest.gps.longitude,
                                         type: 'harvest',
                                         species: harvest.type,
                                         time: harvest.time,
                                         weight: harvest.weight,
                                         locationName: harvest.locationName,
                                         notes: harvest.notes,
                                         sessionDate: session.date
                                     });
                                 } else if (harvest.locationGPS && harvest.locationGPS.includes(',')) {
                                     const coords = harvest.locationGPS.split(',').map(c => parseFloat(c.trim()));
                                     if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                                         points.push({
                                             lat: coords[0],
                                             lng: coords[1],
                                             type: 'harvest',
                                             species: harvest.type,
                                             time: harvest.time,
                                             weight: harvest.weight,
                                             locationName: harvest.locationName,
                                             notes: harvest.notes,
                                             sessionDate: session.date
                                         });
                                     }
                                 }
                             }
                         });
                     }
                     
                     // Observations
                     if (showObservations) {
                         session.observations.forEach(obs => {
                             if (selectedSpecies === 'all' || obs.type === selectedSpecies) {
                                 if (obs.gps) {
                                     points.push({
                                         lat: obs.gps.latitude,
                                         lng: obs.gps.longitude,
                                         type: 'observation',
                                         species: obs.type,
                                         time: obs.time,
                                         count: obs.count,
                                         locationName: obs.locationName,
                                         notes: obs.notes,
                                         sessionDate: session.date
                                     });
                                 } else if (obs.locationGPS && obs.locationGPS.includes(',')) {
                                     const coords = obs.locationGPS.split(',').map(c => parseFloat(c.trim()));
                                     if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                                         points.push({
                                             lat: coords[0],
                                             lng: coords[1],
                                             type: 'observation',
                                             species: obs.type,
                                             time: obs.time,
                                             count: obs.count,
                                             locationName: obs.locationName,
                                             notes: obs.notes,
                                             sessionDate: session.date
                                         });
                                     }
                                 }
                             }
                         });
                     }
                 });
                 
                 if (points.length === 0) {
                     container.innerHTML = `
                         <div class="empty-stats">
                             <h3>Aucun point GPS trouv√©</h3>
                             <p>Ajoutez des pr√©l√®vements ou observations avec GPS pour les voir sur la carte</p>
                         </div>
                     `;
                     return;
                 }
                 
                 // Cr√©er la carte
                 this.createMapVisualization(container, points);
             }
             
             createMapVisualization(container, points) {
                 // Vider le conteneur
                 container.innerHTML = '';
                 
                 // V√©rifier si Leaflet est disponible
                 if (typeof L === 'undefined') {
                     container.innerHTML = `
                         <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6c757d; text-align: center;">
                             <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                             <h3 style="margin-bottom: 8px; color: #495057;">Erreur de chargement de la carte</h3>
                             <p style="font-style: italic;">La biblioth√®que de carte n'a pas pu √™tre charg√©e. V√©rifiez votre connexion internet.</p>
                         </div>
                     `;
                     return;
                 }
                 
                 if (points.length === 0) {
                     // Afficher un message si aucun point
                     container.innerHTML = `
                         <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6c757d; text-align: center;">
                             <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
                             <h3 style="margin-bottom: 8px; color: #495057;">Aucun point GPS √† afficher</h3>
                             <p style="font-style: italic;">Ajoutez des pr√©l√®vements ou observations avec GPS pour les voir sur la carte</p>
                         </div>
                     `;
                     return;
                 }
                 
                 try {
                     // Cr√©er la carte Leaflet
                     const map = L.map(container).setView([46.603354, 1.888334], 6); // Centre de la France
                     
                     // Ajouter la couche OpenStreetMap
                     L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                         attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                         maxZoom: 19
                     }).addTo(map);
                     
                     // Cr√©er des groupes pour les diff√©rents types de points
                     const harvestGroup = L.layerGroup();
                     const observationGroup = L.layerGroup();
                     
                     // Ajouter les points √† la carte
                     points.forEach(point => {
                         // Cr√©er l'ic√¥ne personnalis√©e
                         const icon = L.divIcon({
                             className: 'custom-marker',
                             html: `<div style="
                                 width: 20px; 
                                 height: 20px; 
                                 background-color: ${point.type === 'harvest' ? '#dc3545' : '#ffc107'}; 
                                 border: 3px solid white; 
                                 border-radius: 50%; 
                                 box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                 display: flex;
                                 align-items: center;
                                 justify-content: center;
                                 font-size: 12px;
                                 color: white;
                                 font-weight: bold;
                             ">${point.type === 'harvest' ? 'üèπ' : 'üëÅÔ∏è'}</div>`,
                             iconSize: [20, 20],
                             iconAnchor: [10, 10]
                         });
                         
                         // Cr√©er le contenu de la popup
                         const popupContent = `
                             <div style="min-width: 200px;">
                                 <h3>${point.species}</h3>
                                 <div class="popup-detail">
                                     <strong>Type:</strong>
                                     <span style="color: ${point.type === 'harvest' ? '#dc3545' : '#ffc107'};">
                                         ${point.type === 'harvest' ? 'üèπ Pr√©l√®vement' : 'üëÅÔ∏è Observation'}
                                     </span>
                                 </div>
                                 <div class="popup-detail">
                                     <strong>Date:</strong>
                                     <span>${new Date(point.sessionDate).toLocaleDateString('fr-FR')}</span>
                                 </div>
                                 <div class="popup-detail">
                                     <strong>Heure:</strong>
                                     <span>${point.time}</span>
                                 </div>
                                 ${point.locationName ? `
                                     <div class="popup-detail">
                                         <strong>Lieu:</strong>
                                         <span>${point.locationName}</span>
                                     </div>
                                 ` : ''}
                                 ${point.type === 'harvest' && point.weight ? `
                                     <div class="popup-detail">
                                         <strong>Poids:</strong>
                                         <span>${point.weight} kg</span>
                                     </div>
                                 ` : ''}
                                 ${point.type === 'observation' && point.count ? `
                                     <div class="popup-detail">
                                         <strong>Nombre:</strong>
                                         <span>${point.count} animaux</span>
                                     </div>
                                 ` : ''}
                                 ${point.notes ? `
                                     <div class="popup-detail" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e9ecef;">
                                         <strong>Notes:</strong>
                                         <span style="font-style: italic;">${point.notes}</span>
                                     </div>
                                 ` : ''}
                             </div>
                         `;
                         
                         // Cr√©er le marqueur
                         const marker = L.marker([point.lat, point.lng], { icon: icon })
                             .bindPopup(popupContent)
                             .addTo(point.type === 'harvest' ? harvestGroup : observationGroup);
                     });
                     
                     // Ajouter les groupes √† la carte
                     harvestGroup.addTo(map);
                     observationGroup.addTo(map);
                     
                     // Ajouter les points d'int√©r√™t
                     this.loadPOIOnMap();
                     
                     // Ajouter les trajets GPS des sessions
                     this.loadSessionTracksOnMap();
                     
                     // Ajuster la vue pour inclure tous les points
                     if (points.length > 0) {
                         const bounds = L.latLngBounds(points.map(p => [p.lat, p.lng]));
                         map.fitBounds(bounds, { padding: [20, 20] });
                     }
                     
                     // Ajouter les contr√¥les de couches
                     const overlayMaps = {
                         "üèπ Pr√©l√®vements": harvestGroup,
                         "üëÅÔ∏è Observations": observationGroup
                     };
                     
                     L.control.layers(null, overlayMaps, {
                         collapsed: false,
                         position: 'topright'
                     }).addTo(map);
                     
                     // Ajouter les informations de la carte
                     const infoDiv = document.createElement('div');
                     infoDiv.style.cssText = `
                         position: absolute;
                         top: 15px;
                         left: 15px;
                         background: rgba(255,255,255,0.95);
                         padding: 12px;
                         border-radius: 8px;
                         font-size: 12px;
                         color: #495057;
                         z-index: 1000;
                         box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                         border: 1px solid rgba(0,0,0,0.1);
                         min-width: 150px;
                     `;
                     infoDiv.innerHTML = `
                         <div style="font-weight: bold; margin-bottom: 8px; color: #2c5530;">üó∫Ô∏è Points affich√©s</div>
                         <div style="display: flex; align-items: center; margin-bottom: 4px;">
                             <span style="color: #dc3545; margin-right: 8px;">üèπ</span>
                             <span>Pr√©l√®vements: <strong>${points.filter(p => p.type === 'harvest').length}</strong></span>
                         </div>
                         <div style="display: flex; align-items: center;">
                             <span style="color: #ffc107; margin-right: 8px;">üëÅÔ∏è</span>
                             <span>Observations: <strong>${points.filter(p => p.type === 'observation').length}</strong></span>
                         </div>
                     `;
                     
                     container.appendChild(infoDiv);
                     
                     // Stocker la r√©f√©rence de la carte pour pouvoir la d√©truire plus tard
                     container.mapInstance = map;
                     
                 } catch (error) {
                     console.error('Erreur lors de la cr√©ation de la carte:', error);
                     container.innerHTML = `
                         <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6c757d; text-align: center;">
                             <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                             <h3 style="margin-bottom: 8px; color: #495057;">Erreur d'affichage de la carte</h3>
                             <p style="font-style: italic;">Impossible de charger la carte. V√©rifiez votre connexion internet.</p>
                             <button onclick="huntingTracker.updateMap()" class="btn-primary" style="margin-top: 16px;">R√©essayer</button>
                         </div>
                     `;
                 }
             }

                         calculateDuration(startTime, endTime) {
                 if (!startTime) return 'Non d√©finie';
                 if (!endTime) return 'En cours';
                 
                 const start = new Date(`2000-01-01 ${startTime}`);
                 const end = new Date(`2000-01-01 ${endTime}`);
                 const diff = end - start;
                 
                 if (diff < 0) return 'Erreur';
                 
                 const hours = Math.floor(diff / (1000 * 60 * 60));
                 const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                 
                 return `${hours}h${minutes.toString().padStart(2, '0')}`;
             }

                         calculateHours(startTime, endTime) {
                 if (!startTime || !endTime) return 0;
                 
                 const start = new Date(`2000-01-01 ${startTime}`);
                 const end = new Date(`2000-01-01 ${endTime}`);
                 const diff = end - start;
                 
                 if (diff < 0) return 0;
                 
                 return Math.round((diff / (1000 * 60 * 60)) * 10) / 10;
             }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

                         loadSettings() {
                 document.getElementById('hunterName').value = this.settings.hunterName || '';
                 document.getElementById('licenseNumber').value = this.settings.licenseNumber || '';
                 document.getElementById('defaultLocation').value = this.settings.defaultLocation || '';
                 
                 // Sauvegarder automatiquement les param√®tres
                 ['hunterName', 'licenseNumber', 'defaultLocation'].forEach(id => {
                     document.getElementById(id).addEventListener('input', (e) => {
                         this.settings[id] = e.target.value;
                         this.saveSettings();
                     });
                 });
                 
                 // Charger et afficher la liste des esp√®ces
                 this.loadGameSpeciesList();
             }
             
             loadGameSpeciesList() {
                 // Initialiser la liste par d√©faut si elle n'existe pas
                 if (!this.settings.gameSpecies || this.settings.gameSpecies.length === 0) {
                     this.settings.gameSpecies = [
                         'Sanglier',
                         'Chevreuil',
                         'Cerf',
                         'Li√®vre',
                         'Faisan',
                         'Perdrix',
                         'Canard',
                         'Pigeon',
                         'B√©casse',
                         'Autre'
                     ];
                     this.saveSettings();
                 }
                 
                 this.renderGameSpeciesList();
                 this.updateHarvestTypeOptions();
             }
             
             renderGameSpeciesList() {
                 const container = document.getElementById('gameSpeciesList');
                 if (!container) return;
                 
                 container.innerHTML = this.settings.gameSpecies.map((species, index) => `
                     <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                         <span style="flex: 1;">${species}</span>
                         <button type="button" onclick="huntingTracker.removeGameSpecies(${index})" 
                                 style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 0.8rem; cursor: pointer;">
                             Supprimer
                         </button>
                     </div>
                 `).join('');
             }
             
             addGameSpecies() {
                 const input = document.getElementById('newSpecies');
                 const species = input.value.trim();
                 
                 if (species && !this.settings.gameSpecies.includes(species)) {
                     this.settings.gameSpecies.push(species);
                     this.saveSettings();
                     this.renderGameSpeciesList();
                     this.updateHarvestTypeOptions();
                     input.value = '';
                     this.showNotification('Esp√®ce ajout√©e !');
                 } else if (this.settings.gameSpecies.includes(species)) {
                     this.showNotification('Cette esp√®ce existe d√©j√† !');
                 }
             }
             
             removeGameSpecies(index) {
                 if (confirm('√ätes-vous s√ªr de vouloir supprimer cette esp√®ce ?')) {
                     this.settings.gameSpecies.splice(index, 1);
                     this.saveSettings();
                     this.renderGameSpeciesList();
                     this.updateHarvestTypeOptions();
                     this.showNotification('Esp√®ce supprim√©e !');
                 }
             }
             
             updateHarvestTypeOptions() {
                 const select = document.getElementById('harvestType');
                 if (!select) return;
                 
                 select.innerHTML = this.settings.gameSpecies.map(species => 
                     `<option value="${species}">${species}</option>`
                 ).join('');
             }

            saveSettings() {
                localStorage.setItem('huntingSettings', JSON.stringify(this.settings));
            }

            saveToStorage() {
                localStorage.setItem('huntingSessions', JSON.stringify(this.sessions));
            }

            exportData() {
                const data = {
                    sessions: this.sessions,
                    settings: this.settings,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `suivi-chasse-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showNotification('Donn√©es export√©es !');
            }

            importData(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (data.sessions && Array.isArray(data.sessions)) {
                            this.sessions = data.sessions;
                            this.saveToStorage();
                        }
                        
                        if (data.settings) {
                            this.settings = { ...this.settings, ...data.settings };
                            this.saveSettings();
                            this.loadSettings();
                        }
                        
                        this.renderSessions();
                        this.updateStats();
                        this.showNotification('Donn√©es import√©es avec succ√®s !');
                        
                    } catch (error) {
                        alert('Erreur lors de l\'importation des donn√©es');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
                
                // R√©initialiser l'input
                e.target.value = '';
            }

            closeAllModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }

            showNotification(message) {
                // Cr√©er une notification temporaire
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #2c5530;
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    animation: slideInRight 0.3s ease;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // Initialiser l'application
        const huntingTracker = new HuntingTracker();
        
        // Enregistrer le Service Worker pour la PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then((registration) => {
                    console.log('Service Worker enregistr√© avec succ√®s:', registration);
                })
                .catch((error) => {
                    console.error('Erreur lors de l\'enregistrement du Service Worker:', error);
                });
        }
        
        // Gestion de l'installation PWA
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Afficher un bouton d'installation personnalis√©
            showInstallButton();
        });
        
        window.addEventListener('appinstalled', () => {
            console.log('PWA install√©e avec succ√®s');
            hideInstallButton();
            deferredPrompt = null;
        });
        
        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.id = 'installPWA';
            installBtn.innerHTML = 'üì± Installer l\'app';
            installBtn.className = 'btn-primary';
            installBtn.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                background: #2c5530;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
            `;
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('R√©sultat de l\'installation:', outcome);
                    deferredPrompt = null;
                    hideInstallButton();
                }
            });
            
            document.body.appendChild(installBtn);
        }
        
        function hideInstallButton() {
            const installBtn = document.getElementById('installPWA');
            if (installBtn) {
                installBtn.remove();
            }
        }
    </script>


<!-- Leaflet map fix v2: stronger guards + diagnostics -->
<script>
(function() {
  function showMapMsg(msg) {
    var box = document.getElementById('mapDebug');
    if (box) { box.textContent = msg; box.style.display = 'block'; }
  }
  function hideMapMsg() {
    var box = document.getElementById('mapDebug');
    if (box) { box.style.display = 'none'; }
  }

  // Add a helper to know if tab is visible
  function isMapTabVisible() {
    var tab = document.getElementById('map');
    return tab && tab.classList.contains('active');
  }

  // Override updateMap with guards
  HuntingTracker.prototype.updateMap = function() {
    var containerId = 'mapCanvas';
    var el = document.getElementById(containerId);
    if (!el) return;

    // Leaflet availability
    if (typeof L === 'undefined') {
      showMapMsg('Leaflet non charg√© (connexion internet requise pour CDN)');
      return;
    }

    // Ensure container has dimensions
    if (!el.offsetWidth || !el.offsetHeight) {
      showMapMsg('Carte masqu√©e (onglet ?). Redimensionnement‚Ä¶');
    } else {
      hideMapMsg();
    }

    // Initialize once
    if (!this.leafletMap) {
      this.leafletMap = L.map(containerId, { zoomControl: true });
      try {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(this.leafletMap);
      } catch (e) {
        showMapMsg('Erreur chargement tuiles OSM');
      }
    }

    // Invalidate size when becoming visible
    setTimeout(() => {
      try { this.leafletMap.invalidateSize(); } catch(e) {}
    }, isMapTabVisible() ? 50 : 350);

    // Reset previous markers
    if (this.markerLayer) {
      this.leafletMap.removeLayer(this.markerLayer);
    }
    this.markerLayer = L.layerGroup().addTo(this.leafletMap);

    // Read filters
    var speciesSelect = document.getElementById('speciesFilter');
    var speciesFilter = speciesSelect ? speciesSelect.value : 'all';
    var showHarvests = document.getElementById('showHarvests') ? document.getElementById('showHarvests').checked : true;
    var showObservations = document.getElementById('showObservations') ? document.getElementById('showObservations').checked : true;

    var points = [];

    var addPoint = (lat, lng, layer) => {
      if (isFinite(lat) && isFinite(lng)) {
        this.markerLayer.addLayer(layer);
        points.push([lat, lng]);
      }
    };

    // Sessions + items
    (this.sessions || []).forEach(session => {
      if (session.locationGPS && session.locationGPS.includes(',')) {
        var parts = session.locationGPS.split(',').map(s => parseFloat(s.trim()));
        if (parts.length === 2 && isFinite(parts[0]) && isFinite(parts[1])) {
          var lat = parts[0], lng = parts[1];
          var popup = `<b>${session.locationName || 'Lieu'}</b><br>${this.formatDate(session.date)}${session.weather ? ' ‚Ä¢ ' + session.weather : ''}`;
          addPoint(lat, lng, L.marker([lat, lng]).bindPopup(popup));
        }
      }

      if (showHarvests && Array.isArray(session.harvests)) {
        session.harvests.forEach(h => {
          if (speciesFilter !== 'all' && h.type !== speciesFilter) return;
          var lat, lng;
          if (h.gps) { lat = parseFloat(h.gps.latitude); lng = parseFloat(h.gps.longitude); }
          else if (h.locationGPS && h.locationGPS.includes(',')) {
            var p = h.locationGPS.split(',').map(s => parseFloat(s.trim()));
            lat = p[0]; lng = p[1];
          }
          if (isFinite(lat) && isFinite(lng)) {
            var circle = L.circleMarker([lat, lng], { radius: 7, color: '#dc3545', fillColor: '#dc3545', fillOpacity: 0.85 });
            var popup = `<b>Pr√©l√®vement</b> - ${h.type || ''}<br>${h.time || ''}${h.weight ? ' ‚Ä¢ ' + h.weight + ' kg' : ''}`;
            circle.bindPopup(popup);
            addPoint(lat, lng, circle);
          }
        });
      }

      if (showObservations && Array.isArray(session.observations)) {
        session.observations.forEach(o => {
          if (speciesFilter !== 'all' && o.type !== speciesFilter) return;
          var lat, lng;
          if (o.gps) { lat = parseFloat(o.gps.latitude); lng = parseFloat(o.gps.longitude); }
          else if (o.locationGPS && o.locationGPS.includes(',')) {
            var p2 = o.locationGPS.split(',').map(s => parseFloat(s.trim()));
            lat = p2[0]; lng = p2[1];
          }
          if (isFinite(lat) && isFinite(lng)) {
            var circle2 = L.circleMarker([lat, lng], { radius: 7, color: '#ffc107', fillColor: '#ffc107', fillOpacity: 0.85 });
            var popup2 = `<b>Observation</b> - ${o.type || ''}<br>${o.time || ''}${o.count ? ' ‚Ä¢ ' + o.count : ''}`;
            circle2.bindPopup(popup2);
            addPoint(lat, lng, circle2);
          }
        });
      }
    });

    // Auto-fill species list once
    if (speciesSelect && speciesSelect.options.length <= 1) {
      var set = new Set();
      (this.sessions || []).forEach(s => {
        (s.harvests || []).forEach(h => { if (h.type) set.add(h.type); });
        (s.observations || []).forEach(o => { if (o.type) set.add(o.type); });
      });
      Array.from(set).sort().forEach(sp => {
        var opt = document.createElement('option');
        opt.value = sp;
        opt.textContent = sp;
        speciesSelect.appendChild(opt);
      });
    }

    // Fit or default
    if (points.length) {
      try {
        this.leafletMap.fitBounds(L.latLngBounds(points), { padding: [30, 30] });
      } catch (e) {
        this.leafletMap.setView([46.603354, 1.888334], 6);
      }
    } else {
      this.leafletMap.setView([46.603354, 1.888334], 6);
      showMapMsg('Aucun point √† afficher (ajoute des coordonn√©es GPS)');
    }
  };

  // Also, when switching tabs, invalidate size after 400ms
  var origSwitch = HuntingTracker.prototype.switchTab;
  HuntingTracker.prototype.switchTab = function(name) {
    origSwitch.call(this, name);
    if (name === 'map' && this.leafletMap) {
      setTimeout(() => { try { this.leafletMap.invalidateSize(); } catch(e) {} }, 400);
    }
  };
})();
</script>
</body>
</html>
